class SecuritySystem{constructor(e={}){this.config={enableXSSProtection:!0,enableCSRFProtection:!0,enableCSPEnforcement:!0,enableInputSanitization:!0,enableOutputEncoding:!0,enableSecureHeaders:!0,enableIntegrityChecks:!0,enableRateLimiting:!0,enableSecureCookies:!0,enableHTTPSEnforcement:!0,enableClickjackingProtection:!0,enableMIMETypeSniffing:!1,enableReferrerPolicy:!0,enableFeaturePolicy:!0,enableTrustedTypes:!0,enableSubresourceIntegrity:!0,xss:{enableDOMPurify:!0,enableTrustedTypes:!0,enableCSPReporting:!0,sanitizeUserInput:!0,validateURLs:!0,escapeHTML:!0,filterDangerousElements:!0,blockInlineScripts:!0},csrf:{enableTokenValidation:!0,enableSameSiteHeaders:!0,enableOriginValidation:!0,enableRefererValidation:!0,tokenExpiration:36e5,tokenRotation:!0},csp:{defaultSrc:["'self'"],scriptSrc:["'self'","'unsafe-inline'","'unsafe-eval'","https://cdn.jsdelivr.net","https://cdn.tailwindcss.com","https://cdnjs.cloudflare.com"],styleSrc:["'self'","'unsafe-inline'","https://fonts.googleapis.com","https://cdnjs.cloudflare.com"],imgSrc:["'self'","data:","https:"],fontSrc:["'self'","https:","data:"],connectSrc:["'self'","https://cdn.jsdelivr.net","https://cdn.tailwindcss.com","https://fonts.googleapis.com","https://fonts.gstatic.com","https://cdnjs.cloudflare.com"],mediaSrc:["'self'"],objectSrc:["'none'"],frameSrc:["'none'"],baseUri:["'self'"],formAction:["'self'"],frameAncestors:["'none'"],upgradeInsecureRequests:!0,reportUri:"/api/security/csp-report"},rateLimit:{requests:100,window:6e4,blockDuration:3e5,enableProgressiveDelay:!0},headers:{"X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","X-XSS-Protection":"1; mode=block","Strict-Transport-Security":"max-age=31536000; includeSubDomains; preload","Referrer-Policy":"strict-origin-when-cross-origin","Permissions-Policy":"geolocation=(), microphone=(), camera=()"},trustedDomains:[window.location.hostname],blockedPatterns:[/<script[^>]*>.*?<\/script>/gi,/javascript:/gi,/vbscript:/gi,/onload=/gi,/onerror=/gi,/onclick=/gi,/onmouseover=/gi],...e},this.csrfToken=null,this.rateLimitData=new Map,this.securityViolations=[],this.trustedTypesPolicy=null,this.init()}async init(){try{this.config.enableXSSProtection&&this.setupXSSProtection(),this.config.enableCSRFProtection&&this.setupCSRFProtection(),this.config.enableCSPEnforcement&&this.setupCSPEnforcement(),this.config.enableInputSanitization&&this.setupInputSanitization(),this.config.enableSecureHeaders&&this.setupSecureHeaders(),this.config.enableIntegrityChecks&&this.setupIntegrityChecks(),this.config.enableRateLimiting&&this.setupRateLimiting(),this.config.enableSecureCookies&&this.setupSecureCookies(),this.config.enableHTTPSEnforcement&&this.setupHTTPSEnforcement(),this.config.enableTrustedTypes&&this.setupTrustedTypes(),this.config.enableSubresourceIntegrity&&this.setupSubresourceIntegrity(),this.setupSecurityMonitoring(),this.emit("security:initialized"),this.log("Security system initialized")}catch(e){console.error("Failed to initialize security system:",e),this.reportSecurityViolation("security_init_error",{error:e.message})}}setupXSSProtection(){this.config.xss.enableDOMPurify&&window.DOMPurify&&(this.domPurify=window.DOMPurify),this.overrideDangerousMethods(),this.setupInputValidation(),this.config.xss.validateURLs&&this.setupURLValidation(),this.monitorXSSAttempts()}overrideDangerousMethods(){const t=Object.getOwnPropertyDescriptor(Element.prototype,"innerHTML"),n=Object.getOwnPropertyDescriptor(Element.prototype,"outerHTML"),s=Element.prototype.insertAdjacentHTML;typeof this._sanitizing!="boolean"&&(this._sanitizing=!1);const e=this;Object.defineProperty(Element.prototype,"innerHTML",{get(){return t.get.call(this)},set(n){if(e._sanitizing)return t.set.call(this,n);const s=e.sanitizeHTML(n);return t.set.call(this,s)}}),Object.defineProperty(Element.prototype,"outerHTML",{get(){return n.get.call(this)},set(t){if(e._sanitizing)return n.set.call(this,t);const s=e.sanitizeHTML(t);return n.set.call(this,s)}}),Element.prototype.insertAdjacentHTML=function(t,n){if(e._sanitizing)return s.call(this,t,n);const o=e.sanitizeHTML(n);return s.call(this,t,o)};const o=document.write;document.write=function(t){if(e._sanitizing)return o.call(document,t);const n=e.sanitizeHTML(t);return o.call(document,n)}}setupInputValidation(){document.addEventListener("input",e=>{e.target.matches("input, textarea")&&this.validateInput(e.target)}),document.addEventListener("submit",e=>{this.validateForm(e.target)||(e.preventDefault(),this.reportSecurityViolation("form_validation_failed",{form:e.target.id||e.target.className}))})}validateInput(e){const t=e.value;for(const n of this.config.blockedPatterns)if(n.test(t)){e.value=this.sanitizeHTML(t),this.reportSecurityViolation("xss_attempt_blocked",{input:e.name||e.id,pattern:n.toString(),value:t.substring(0,100)});break}}validateForm(e){const t=new FormData(e);for(const[n,e]of t.entries())if(typeof e=="string")for(const t of this.config.blockedPatterns)if(t.test(e))return!1;return!0}setupInputSanitization(){try{const e=document.querySelectorAll("input, textarea");e.forEach(e=>{e.addEventListener("input",e=>{this.sanitizeInput(e.target)})}),this.log("Input sanitization setup completed")}catch(e){this.logError("Failed to setup input sanitization",e)}}sanitizeInput(e){const t=e.value,n=this.sanitizeHTML(t);n!==t&&(e.value=n,this.reportSecurityViolation("malicious_input_detected",{field:e.name||e.id,original:t,sanitized:n}))}setupURLValidation(){document.addEventListener("click",e=>{const t=e.target.closest("a");t&&t.href&&(this.validateURL(t.href)||(e.preventDefault(),this.reportSecurityViolation("malicious_url_blocked",{url:t.href})))})}validateURL(e){try{const t=new URL(e);return t.protocol!=="javascript:"&&t.protocol!=="data:"&&(t.hostname===window.location.hostname||this.config.trustedDomains.includes(t.hostname))}catch{return!1}}monitorXSSAttempts(){const e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.scanElementForXSS(e)})})});e.observe(document.body,{childList:!0,subtree:!0})}scanElementForXSS(e){if(e.tagName==="SCRIPT"&&!e.src){this.reportSecurityViolation("inline_script_detected",{content:e.textContent.substring(0,100)}),e.remove();return}const t=["onload","onerror","onclick","onmouseover"];t.forEach(t=>{e.hasAttribute(t)&&(this.reportSecurityViolation("dangerous_attribute_detected",{element:e.tagName,attribute:t,value:e.getAttribute(t)}),e.removeAttribute(t))}),e.querySelectorAll("*").forEach(e=>{this.scanElementForXSS(e)})}setupCSRFProtection(){this.generateCSRFToken(),this.addCSRFTokenToForms(),this.validateCSRFTokens(),this.config.csrf.tokenRotation&&this.setupTokenRotation()}generateCSRFToken(){const e=new Uint8Array(32);crypto.getRandomValues(e),this.csrfToken=Array.from(e,e=>e.toString(16).padStart(2,"0")).join("");const t={token:this.csrfToken,expires:Date.now()+this.config.csrf.tokenExpiration};sessionStorage.setItem("csrf_token",JSON.stringify(t))}addCSRFTokenToForms(){const e=document.querySelectorAll("form");e.forEach(e=>{if(!e.querySelector('input[name="csrf_token"]')){const t=document.createElement("input");t.type="hidden",t.name="csrf_token",t.value=this.csrfToken,e.appendChild(t)}})}validateCSRFTokens(){document.addEventListener("submit",e=>{const t=e.target,n=t.querySelector('input[name="csrf_token"]');(!n||!this.validateCSRFToken(n.value))&&(e.preventDefault(),this.reportSecurityViolation("csrf_token_invalid",{form:t.id||t.className}))})}validateCSRFToken(e){const t=sessionStorage.getItem("csrf_token");if(!t)return!1;try{const n=JSON.parse(t);return!(Date.now()>n.expires)&&n.token===e}catch{return!1}}setupTokenRotation(){setInterval(()=>{this.generateCSRFToken(),this.addCSRFTokenToForms()},this.config.csrf.tokenExpiration/2)}setupCSPEnforcement(){const e=this.generateCSPHeader();if(!document.querySelector('meta[http-equiv="Content-Security-Policy"]')){const t=document.createElement("meta");t.httpEquiv="Content-Security-Policy",t.content=e,document.head.appendChild(t)}document.addEventListener("securitypolicyviolation",e=>{this.reportSecurityViolation("csp_violation",{violatedDirective:e.violatedDirective,blockedURI:e.blockedURI,documentURI:e.documentURI,originalPolicy:e.originalPolicy})})}generateCSPHeader(){const e=[];return Object.entries(this.config.csp).forEach(([t,n])=>{if(t==="reportUri")e.push(`report-uri ${n}`);else if(t==="upgradeInsecureRequests"&&n)e.push("upgrade-insecure-requests");else if(Array.isArray(n)){const s=t.replace(/([A-Z])/g,"-$1").toLowerCase();e.push(`${s} ${n.join(" ")}`)}}),e.join("; ")}setupSecureHeaders(){Object.entries(this.config.headers).forEach(([e,t])=>{if(e==="X-Content-Type-Options"){const n=document.createElement("meta");n.httpEquiv=e,n.content=t,document.head.appendChild(n)}})}setupIntegrityChecks(){const e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="SCRIPT"||e.tagName==="LINK")&&this.checkResourceIntegrity(e)})})});e.observe(document.head,{childList:!0,subtree:!0})}checkResourceIntegrity(e){const t=e.src||e.href;t&&this.isExternalResource(t)&&(e.integrity||this.reportSecurityViolation("missing_integrity_check",{element:e.tagName,src:t}))}isExternalResource(e){try{const t=new URL(e);return t.hostname!==window.location.hostname}catch{return!1}}setupRateLimiting(){const e=window.fetch;window.fetch=(...t)=>this.isRateLimited()?Promise.reject(new Error("Rate limit exceeded")):(this.recordRequest(),e.apply(window,t)),document.addEventListener("submit",e=>{this.isRateLimited()?(e.preventDefault(),this.reportSecurityViolation("rate_limit_exceeded",{form:e.target.id||e.target.className})):this.recordRequest()})}isRateLimited(){const e=Date.now(),t=e-this.config.rateLimit.window;for(const[e]of this.rateLimitData)e<t&&this.rateLimitData.delete(e);return this.rateLimitData.size>=this.config.rateLimit.requests}recordRequest(){const e=Date.now();this.rateLimitData.set(e,!0)}setupSecureCookies(){const e=Object.getOwnPropertyDescriptor(Document.prototype,"cookie"),t=this;Object.defineProperty(document,"cookie",{get(){return e.get.call(this)},set(n){const s=t.makeSecureCookie(n);return e.set.call(this,s)}})}makeSecureCookie(e){let t=e;return window.location.protocol==="https:"&&!t.includes("Secure")&&(t+="; Secure"),t.includes("HttpOnly")||(t+="; HttpOnly"),t.includes("SameSite")||(t+="; SameSite=Strict"),t}setupHTTPSEnforcement(){window.location.protocol==="http:"&&window.location.hostname!=="localhost"&&(window.location.href=window.location.href.replace("http:","https:")),this.monitorMixedContent()}monitorMixedContent(){const e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.checkMixedContent(e)})})});e.observe(document.body,{childList:!0,subtree:!0})}checkMixedContent(e){const t=["src","href","action"];t.forEach(t=>{const n=e.getAttribute(t);n&&n.startsWith("http:")&&window.location.protocol==="https:"&&(this.reportSecurityViolation("mixed_content_detected",{element:e.tagName,attribute:t,value:n}),e.setAttribute(t,n.replace("http:","https:")))})}setupTrustedTypes(){if("trustedTypes"in window)try{this.trustedTypesPolicy=trustedTypes.createPolicy("default",{createHTML:e=>this.sanitizeHTML(e),createScript:e=>{if(this.isTrustedScript(e))return e;throw new Error("Untrusted script blocked")},createScriptURL:e=>{if(this.validateURL(e))return e;throw new Error("Untrusted script URL blocked")}})}catch(e){console.warn("Failed to create trusted types policy:",e)}}isTrustedScript(){return!1}setupSubresourceIntegrity(){const e=document.querySelectorAll("script[src], link[href]");e.forEach(e=>{const t=e.src||e.href;this.isExternalResource(t)&&!e.integrity&&this.generateIntegrityHash(e,t)})}async generateIntegrityHash(e,t){try{const n=await fetch(t),s=await n.text(),o=new TextEncoder,i=o.encode(s),a=await crypto.subtle.digest("SHA-384",i),r=Array.from(new Uint8Array(a)),c=btoa(String.fromCharCode.apply(null,r));e.integrity=`sha384-${c}`,e.crossOrigin="anonymous"}catch(e){console.warn("Failed to generate integrity hash:",e)}}setupSecurityMonitoring(){window.addEventListener("error",e=>{e.message.includes("Content Security Policy")&&this.reportSecurityViolation("csp_error",{message:e.message,filename:e.filename,lineno:e.lineno})}),this.monitorSuspiciousActivity(),this.setupSecurityReporting()}monitorSuspiciousActivity(){let e=0,t=0;document.addEventListener("click",()=>{const n=Date.now();n-t<100?(e++,e>10&&this.reportSecurityViolation("suspicious_rapid_clicks",{count:e,timespan:n-t})):e=0,t=n})}setupSecurityReporting(){setInterval(()=>{this.securityViolations.length>0&&this.sendSecurityReport()},6e4),window.addEventListener("beforeunload",()=>{this.securityViolations.length>0&&this.sendSecurityReport(!0)})}sendSecurityReport(){this.config.debug&&console.log("Security violations detected:",{violations:[...this.securityViolations],timestamp:Date.now(),userAgent:navigator.userAgent,url:window.location.href}),this.securityViolations=[]}sanitizeHTML(e){if(!e||typeof e!="string")return"";if(this.domPurify)return this.domPurify.sanitize(e);try{if(this._sanitizing=!0,e.includes("&amp;")&&e.includes("appendChild"))return console.warn("Potentially problematic HTML detected, applying conservative sanitization"),this.conservativeSanitize(e);const t=document.createElement("div"),n=document.createElement("textarea");n.innerHTML=e;const s=n.value;t.textContent=s;const o=t.innerHTML;t.innerHTML=o;const i=t.querySelectorAll("script, object, embed, iframe, form, input, textarea, select, button");i.forEach(e=>e.remove());const a=t.querySelectorAll("*");return a.forEach(e=>{const t=["onclick","onload","onerror","onmouseover","onfocus","onblur","onchange","onsubmit"];t.forEach(t=>{e.hasAttribute(t)&&e.removeAttribute(t)})}),t.innerHTML}catch(t){return console.warn("HTML sanitization failed:",t),this.conservativeSanitize(e)}finally{this._sanitizing=!1}}conservativeSanitize(e){try{return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}catch(e){return console.warn("Conservative sanitization failed:",e),""}}reportSecurityViolation(e,t){const n={type:e,details:t,timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent};this.securityViolations.push(n),this.emit("security:violation",n),this.log(`Security violation: ${e}`,t)}sanitize(e){return this.sanitizeHTML(e)}validateInput(e){for(const t of this.config.blockedPatterns)if(t.test(e))return!1;return!0}generateSecureToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}hashData(e){return crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)).then(e=>{const t=Array.from(new Uint8Array(e));return t.map(e=>e.toString(16).padStart(2,"0")).join("")})}emit(e,t){const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}on(e,t){document.addEventListener(e,t)}log(e,t=null){this.config.enableDebugging&&(t?console.log(`[Security] ${e}`,t):console.log(`[Security] ${e}`))}getSecurityStatus(){return{xssProtection:this.config.enableXSSProtection,csrfProtection:this.config.enableCSRFProtection,cspEnforcement:this.config.enableCSPEnforcement,httpsEnforced:window.location.protocol==="https:",violations:this.securityViolations.length,lastViolation:this.securityViolations[this.securityViolations.length-1]}}}window.TechBlogSecurity=new SecuritySystem,typeof module!="undefined"&&module.exports&&(module.exports=SecuritySystem),window.SecuritySystem=SecuritySystem