class AnalyticsSystem{constructor(e={}){this.config={enableUserTracking:!0,enablePerformanceTracking:!0,enableErrorTracking:!0,enableHeatmaps:!0,enableSessionRecording:!1,enableA11yTracking:!0,enableCustomEvents:!0,enableRealTimeAnalytics:!0,enableOfflineTracking:!0,enablePrivacyMode:!0,tracking:{pageViews:!0,clicks:!0,scrolling:!0,formInteractions:!0,searchQueries:!0,downloads:!0,outboundLinks:!0,videoInteractions:!0,socialSharing:!0,userJourney:!0},performance:{coreWebVitals:!0,resourceTiming:!0,navigationTiming:!0,userTiming:!0,memoryUsage:!0,networkInformation:!0,batteryStatus:!0,deviceInformation:!0},errors:{javascriptErrors:!0,unhandledPromises:!0,resourceErrors:!0,networkErrors:!0,consoleErrors:!0,customErrors:!0,errorBoundaries:!0},privacy:{respectDoNotTrack:!0,anonymizeIPs:!0,cookieConsent:!0,dataRetention:90,allowOptOut:!0,gdprCompliant:!0},collection:{batchSize:10,flushInterval:3e4,maxRetries:3,retryDelay:1e3,compressionEnabled:!0,encryptionEnabled:!0},endpoints:{events:"/api/analytics/events",performance:"/api/analytics/performance",errors:"/api/analytics/errors",heatmaps:"/api/analytics/heatmaps"},...e},this.sessionId=this.generateSessionId(),this.userId=this.getUserId(),this.deviceId=this.getDeviceId(),this.eventQueue=[],this.performanceQueue=[],this.errorQueue=[],this.heatmapQueue=[],this.sessionData={startTime:Date.now(),pageViews:0,interactions:0,scrollDepth:0,timeOnPage:0,referrer:document.referrer,userAgent:navigator.userAgent},this.performanceMetrics={},this.errorMetrics={},this.userBehavior={},this.observers=[],this.eventListeners=[],this.timers=[],this.init()}async init(){try{if(!this.checkPrivacyConsent()){this.log("Analytics disabled due to privacy settings");return}this.config.enableUserTracking&&this.initUserTracking(),this.config.enablePerformanceTracking&&this.initPerformanceTracking(),this.config.enableErrorTracking&&this.initErrorTracking(),this.config.enableHeatmaps&&this.initHeatmapTracking(),this.config.enableA11yTracking&&this.initAccessibilityTracking(),this.config.enableOfflineTracking&&this.initOfflineTracking(),this.setupDataCollection(),this.config.enableRealTimeAnalytics&&this.setupRealTimeAnalytics(),this.trackPageView(),this.emit("analytics:initialized"),this.log("Analytics system initialized")}catch(e){console.error("Failed to initialize analytics:",e),this.trackError("analytics_init_error",e)}}checkPrivacyConsent(){if(this.config.privacy.respectDoNotTrack&&navigator.doNotTrack==="1")return!1;if(this.config.privacy.cookieConsent){const e=localStorage.getItem("analytics_consent");return e==="granted"}return!0}initUserTracking(){this.config.tracking.pageViews&&this.trackPageViewChanges(),this.config.tracking.clicks&&this.trackClicks(),this.config.tracking.scrolling&&this.trackScrolling(),this.config.tracking.formInteractions&&this.trackFormInteractions(),this.config.tracking.searchQueries&&this.trackSearchQueries(),this.config.tracking.downloads&&this.trackDownloads(),this.config.tracking.outboundLinks&&this.trackOutboundLinks(),this.config.tracking.videoInteractions&&this.trackVideoInteractions(),this.config.tracking.socialSharing&&this.trackSocialSharing(),this.config.tracking.userJourney&&this.trackUserJourney()}trackPageViewChanges(){this.trackPageView();const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),setTimeout(()=>this.trackPageView(),0)},history.replaceState=(...e)=>{t.apply(history,e),setTimeout(()=>this.trackPageView(),0)},window.addEventListener("popstate",()=>{setTimeout(()=>this.trackPageView(),0)})}trackPageView(){const e={url:window.location.href,path:window.location.pathname,title:document.title,referrer:document.referrer,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId};this.sessionData.pageViews++,this.queueEvent("page_view",e),this.sessionData.timeOnPage=0,this.sessionData.scrollDepth=0,this.emit("analytics:pageView",e)}trackClicks(){const e=e=>{const t=e.target,n={elementType:t.tagName.toLowerCase(),elementId:t.id,elementClass:t.className,elementText:t.textContent?.substring(0,100),x:e.clientX,y:e.clientY,timestamp:Date.now(),sessionId:this.sessionId};this.sessionData.interactions++,this.queueEvent("click",n),this.config.enableHeatmaps&&this.queueHeatmapData("click",{x:e.clientX,y:e.clientY,timestamp:Date.now()})};document.addEventListener("click",e),this.eventListeners.push({element:document,event:"click",handler:e})}trackScrolling(){let e=0,t;const n=()=>{const n=window.pageYOffset||document.documentElement.scrollTop,o=document.documentElement.scrollHeight-window.innerHeight,s=Math.round(n/o*100);s>e&&(e=s,this.sessionData.scrollDepth=e),clearTimeout(t),t=setTimeout(()=>{this.queueEvent("scroll",{scrollDepth:e,scrollTop:n,timestamp:Date.now(),sessionId:this.sessionId})},1e3)};window.addEventListener("scroll",n,{passive:!0}),this.eventListeners.push({element:window,event:"scroll",handler:n})}trackFormInteractions(){const e=(e,t)=>{const n={eventType:e,formId:t.form?.id,fieldName:t.name,fieldType:t.type,fieldValue:t.type==="password"?"[REDACTED]":t.value?.substring(0,100),timestamp:Date.now(),sessionId:this.sessionId};this.queueEvent("form_interaction",n)};document.addEventListener("submit",t=>{e("submit",t.target)}),document.addEventListener("focus",t=>{t.target.matches("input, textarea, select")&&e("focus",t.target)},!0),document.addEventListener("blur",t=>{t.target.matches("input, textarea, select")&&e("blur",t.target)},!0)}trackSearchQueries(){const e=document.querySelectorAll('input[type="search"], input[name*="search"], input[id*="search"]');e.forEach(e=>{let t;e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{e.value.length>2&&this.queueEvent("search_query",{query:e.value,timestamp:Date.now(),sessionId:this.sessionId})},1e3)})})}trackDownloads(){document.addEventListener("click",e=>{const t=e.target.closest("a");if(!t)return;const n=t.href,s=/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar|mp3|mp4|avi|mov)$/i;(s.test(n)||t.hasAttribute("download"))&&this.queueEvent("download",{url:n,filename:t.download||n.split("/").pop(),timestamp:Date.now(),sessionId:this.sessionId})})}trackOutboundLinks(){document.addEventListener("click",e=>{const t=e.target.closest("a");if(!t)return;const n=t.href,s=window.location.hostname;try{const e=new URL(n).hostname;e!==s&&this.queueEvent("outbound_link",{url:n,domain:e,timestamp:Date.now(),sessionId:this.sessionId})}catch{}})}trackVideoInteractions(){const e=document.querySelectorAll("video");e.forEach(e=>{const t=t=>{this.queueEvent("video_interaction",{eventType:t,videoSrc:e.src||e.currentSrc,currentTime:e.currentTime,duration:e.duration,timestamp:Date.now(),sessionId:this.sessionId})};e.addEventListener("play",()=>t("play")),e.addEventListener("pause",()=>t("pause")),e.addEventListener("ended",()=>t("ended")),e.addEventListener("seeked",()=>t("seeked"))})}trackSocialSharing(){document.addEventListener("click",e=>{const t=e.target.closest("a");if(!t)return;const n=t.href,s={"facebook.com":"facebook","twitter.com":"twitter","linkedin.com":"linkedin","pinterest.com":"pinterest","reddit.com":"reddit","whatsapp.com":"whatsapp"};for(const[e,t]of Object.entries(s))if(n.includes(e)){this.queueEvent("social_share",{platform:t,url:n,timestamp:Date.now(),sessionId:this.sessionId});break}})}trackUserJourney(){const e={pages:[],interactions:[],startTime:Date.now(),sessionId:this.sessionId};this.on("analytics:pageView",t=>{e.pages.push({url:t.detail.url,title:t.detail.title,timestamp:t.detail.timestamp})}),this.on("analytics:click",t=>{e.interactions.push({type:"click",element:t.detail.elementType,timestamp:t.detail.timestamp})});const t=()=>{this.queueEvent("user_journey",e)},n=setInterval(t,6e4);this.timers.push(n),window.addEventListener("beforeunload",t)}initPerformanceTracking(){this.config.performance.coreWebVitals&&this.trackCoreWebVitals(),this.config.performance.resourceTiming&&this.trackResourceTiming(),this.config.performance.navigationTiming&&this.trackNavigationTiming(),this.config.performance.userTiming&&this.trackUserTiming(),this.config.performance.memoryUsage&&this.trackMemoryUsage(),this.config.performance.networkInformation&&this.trackNetworkInformation(),this.config.performance.deviceInformation&&this.trackDeviceInformation()}trackCoreWebVitals(){if("PerformanceObserver"in window){const e=new PerformanceObserver(e=>{const t=e.getEntries(),n=t[t.length-1];this.performanceMetrics.lcp=n.startTime,this.queuePerformanceData("lcp",{value:n.startTime,timestamp:Date.now()})});e.observe({entryTypes:["largest-contentful-paint"]}),this.observers.push(e)}if("PerformanceObserver"in window){const e=new PerformanceObserver(e=>{const t=e.getEntries();t.forEach(e=>{this.performanceMetrics.fid=e.processingStart-e.startTime,this.queuePerformanceData("fid",{value:e.processingStart-e.startTime,timestamp:Date.now()})})});e.observe({entryTypes:["first-input"]}),this.observers.push(e)}if("PerformanceObserver"in window){let e=0;const t=new PerformanceObserver(t=>{const n=t.getEntries();n.forEach(t=>{t.hadRecentInput||(e+=t.value)}),this.performanceMetrics.cls=e,this.queuePerformanceData("cls",{value:e,timestamp:Date.now()})});t.observe({entryTypes:["layout-shift"]}),this.observers.push(t)}}trackResourceTiming(){if("PerformanceObserver"in window){const e=new PerformanceObserver(e=>{const t=e.getEntries();t.forEach(e=>{this.queuePerformanceData("resource",{name:e.name,type:e.initiatorType,duration:e.duration,size:e.transferSize,timestamp:Date.now()})})});e.observe({entryTypes:["resource"]}),this.observers.push(e)}}trackNavigationTiming(){window.addEventListener("load",()=>{const e=performance.getEntriesByType("navigation")[0];e&&this.queuePerformanceData("navigation",{domContentLoaded:e.domContentLoadedEventEnd-e.domContentLoadedEventStart,loadComplete:e.loadEventEnd-e.loadEventStart,domInteractive:e.domInteractive-e.navigationStart,timestamp:Date.now()})})}trackUserTiming(){if("PerformanceObserver"in window){const e=new PerformanceObserver(e=>{const t=e.getEntries();t.forEach(e=>{this.queuePerformanceData("user_timing",{name:e.name,type:e.entryType,duration:e.duration,timestamp:Date.now()})})});e.observe({entryTypes:["measure","mark"]}),this.observers.push(e)}}trackMemoryUsage(){if("memory"in performance){const e=()=>{this.queuePerformanceData("memory",{usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit,timestamp:Date.now()})},t=setInterval(e,3e4);this.timers.push(t),e()}}trackNetworkInformation(){if("connection"in navigator){const e=()=>{this.queuePerformanceData("network",{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt,saveData:navigator.connection.saveData,timestamp:Date.now()})};navigator.connection.addEventListener("change",e),e()}}trackDeviceInformation(){const e={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine,screenWidth:screen.width,screenHeight:screen.height,colorDepth:screen.colorDepth,pixelRatio:window.devicePixelRatio,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timestamp:Date.now()};this.queuePerformanceData("device",e)}initErrorTracking(){this.config.errors.javascriptErrors&&this.trackJavaScriptErrors(),this.config.errors.unhandledPromises&&this.trackUnhandledPromises(),this.config.errors.resourceErrors&&this.trackResourceErrors(),this.config.errors.consoleErrors&&this.trackConsoleErrors()}trackJavaScriptErrors(){window.addEventListener("error",e=>{this.trackError("javascript_error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:e.error?.stack})})}trackUnhandledPromises(){window.addEventListener("unhandledrejection",e=>{this.trackError("unhandled_promise",{reason:e.reason?.toString(),stack:e.reason?.stack})})}trackResourceErrors(){window.addEventListener("error",e=>{e.target!==window&&this.trackError("resource_error",{type:e.target.tagName,source:e.target.src||e.target.href,message:"Resource failed to load"})},!0)}trackConsoleErrors(){const e=console.error;console.error=(...t)=>{this.trackError("console_error",{message:t.join(" "),arguments:t}),e.apply(console,t)}}trackError(e,t){const n={type:e,...t,url:window.location.href,userAgent:navigator.userAgent,timestamp:Date.now(),sessionId:this.sessionId};this.queueErrorData(n),this.emit("analytics:error",n)}initHeatmapTracking(){let e;document.addEventListener("mousemove",t=>{clearTimeout(e),e=setTimeout(()=>{this.queueHeatmapData("mousemove",{x:t.clientX,y:t.clientY,timestamp:Date.now()})},100)});let t;window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.queueHeatmapData("scroll",{scrollX:window.pageXOffset,scrollY:window.pageYOffset,timestamp:Date.now()})},100)})}initAccessibilityTracking(){document.addEventListener("keydown",e=>{e.key==="Tab"&&this.queueEvent("a11y_keyboard_nav",{key:e.key,shiftKey:e.shiftKey,target:e.target.tagName,timestamp:Date.now()})}),document.addEventListener("focus",e=>{this.queueEvent("a11y_focus",{target:e.target.tagName,targetId:e.target.id,timestamp:Date.now()})},!0),(navigator.userAgent.includes("NVDA")||navigator.userAgent.includes("JAWS"))&&this.queueEvent("a11y_screen_reader",{userAgent:navigator.userAgent,timestamp:Date.now()})}initOfflineTracking(){window.addEventListener("offline",()=>{this.isOffline=!0,this.saveOfflineData()}),window.addEventListener("online",()=>{this.isOffline=!1,this.syncOfflineData()})}saveOfflineData(){const e={events:[...this.eventQueue],performance:[...this.performanceQueue],errors:[...this.errorQueue],heatmaps:[...this.heatmapQueue],timestamp:Date.now()};localStorage.setItem("analytics_offline_data",JSON.stringify(e))}async syncOfflineData(){const e=localStorage.getItem("analytics_offline_data");if(e)try{const t=JSON.parse(e);this.eventQueue.unshift(...t.events),this.performanceQueue.unshift(...t.performance),this.errorQueue.unshift(...t.errors),this.heatmapQueue.unshift(...t.heatmaps),localStorage.removeItem("analytics_offline_data"),await this.flushAllData(),this.log("Offline data synced successfully")}catch(e){console.error("Failed to sync offline data:",e)}}setupDataCollection(){const e=setInterval(()=>{this.flushAllData()},this.config.collection.flushInterval);this.timers.push(e),window.addEventListener("beforeunload",()=>{this.flushAllData(!0)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.flushAllData()})}setupRealTimeAnalytics(){if("WebSocket"in window)try{this.websocket=new WebSocket("wss://analytics.example.com/realtime"),this.websocket.onopen=()=>{this.log("Real-time analytics connected")},this.websocket.onmessage=e=>{const t=JSON.parse(e.data);this.handleRealTimeMessage(t)},this.websocket.onerror=e=>{console.error("WebSocket error:",e)}}catch(e){console.error("Failed to setup real-time analytics:",e)}}handleRealTimeMessage(e){switch(e.type){case"config_update":this.updateConfig(e.config);break;case"experiment":this.handleExperiment(e.experiment);break;default:this.log("Unknown real-time message:",e)}}queueEvent(e,t){const n={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId};this.eventQueue.push(n),this.eventQueue.length>=this.config.collection.batchSize&&this.flushEvents()}queuePerformanceData(e,t){const n={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId};this.performanceQueue.push(n),this.performanceQueue.length>=this.config.collection.batchSize&&this.flushPerformanceData()}queueErrorData(e){this.errorQueue.push(e),this.errorQueue.length>=this.config.collection.batchSize&&this.flushErrorData()}queueHeatmapData(e,t){const n={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId};this.heatmapQueue.push(n),this.heatmapQueue.length>=this.config.collection.batchSize&&this.flushHeatmapData()}async flushAllData(e=!1){const t=[];this.eventQueue.length>0&&t.push(this.flushEvents()),this.performanceQueue.length>0&&t.push(this.flushPerformanceData()),this.errorQueue.length>0&&t.push(this.flushErrorData()),this.heatmapQueue.length>0&&t.push(this.flushHeatmapData()),e?this.sendBeaconData():await Promise.all(t)}async flushEvents(){if(this.eventQueue.length===0)return;const e=[...this.eventQueue];this.eventQueue=[];try{await this.sendData(this.config.endpoints.events,e)}catch(t){throw this.eventQueue.unshift(...e),t}}async flushPerformanceData(){if(this.performanceQueue.length===0)return;const e=[...this.performanceQueue];this.performanceQueue=[];try{await this.sendData(this.config.endpoints.performance,e)}catch(t){throw this.performanceQueue.unshift(...e),t}}async flushErrorData(){if(this.errorQueue.length===0)return;const e=[...this.errorQueue];this.errorQueue=[];try{await this.sendData(this.config.endpoints.errors,e)}catch(t){throw this.errorQueue.unshift(...e),t}}async flushHeatmapData(){if(this.heatmapQueue.length===0)return;const e=[...this.heatmapQueue];this.heatmapQueue=[];try{await this.sendData(this.config.endpoints.heatmaps,e)}catch(t){throw this.heatmapQueue.unshift(...e),t}}async sendData(e,t){const s={sessionId:this.sessionId,userId:this.userId,deviceId:this.deviceId,timestamp:Date.now(),data:t};let n=0;for(;n<this.config.collection.maxRetries;)try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(t.ok)return;throw new Error(`HTTP ${t.status}`)}catch(e){if(n++,n<this.config.collection.maxRetries)await new Promise(e=>setTimeout(e,this.config.collection.retryDelay*n));else throw e}}sendBeaconData(){if("sendBeacon"in navigator){const e={events:this.eventQueue,performance:this.performanceQueue,errors:this.errorQueue,heatmaps:this.heatmapQueue,sessionId:this.sessionId,userId:this.userId,timestamp:Date.now()};navigator.sendBeacon("/api/analytics/beacon",JSON.stringify(e)),this.eventQueue=[],this.performanceQueue=[],this.errorQueue=[],this.heatmapQueue=[]}}generateSessionId(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}getUserId(){let e=localStorage.getItem("analytics_user_id");return e||(e="user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("analytics_user_id",e)),e}getDeviceId(){let e=localStorage.getItem("analytics_device_id");return e||(e="device_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("analytics_device_id",e)),e}track(e,t={}){this.queueEvent("custom_event",{name:e,properties:t})}identify(e,t={}){this.userId=e,localStorage.setItem("analytics_user_id",e),this.queueEvent("identify",{userId:e,traits:t})}page(e,t={}){this.queueEvent("page",{name:e,properties:t,url:window.location.href,title:document.title})}setUserProperties(e){this.queueEvent("user_properties",e)}startTiming(e){performance.mark(`${e}_start`)}endTiming(e){performance.mark(`${e}_end`),performance.measure(e,`${e}_start`,`${e}_end`)}emit(e,t){const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}on(e,t){document.addEventListener(e,t)}log(e,t=null){this.config.enableDebugging&&(t?console.log(`[Analytics] ${e}`,t):console.log(`[Analytics] ${e}`))}destroy(){this.flushAllData(!0),this.timers.forEach(e=>clearInterval(e)),this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e.removeEventListener(t,n)}),this.observers.forEach(e=>e.disconnect()),this.websocket&&this.websocket.close(),this.timers=[],this.eventListeners=[],this.observers=[],this.eventQueue=[],this.performanceQueue=[],this.errorQueue=[],this.heatmapQueue=[]}}window.TechBlogAnalytics=new AnalyticsSystem,typeof module!="undefined"&&module.exports&&(module.exports=AnalyticsSystem),window.AnalyticsSystem=AnalyticsSystem