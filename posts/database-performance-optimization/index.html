<!DOCTYPE html>
<html lang="zh" class="scroll-smooth">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <title>Database Performance Optimization Strategies: From Query Tuning to System Architecture | Êª¥Ê∞¥ÊÅíÂøÉ</title>
    


<meta name="description" content="A comprehensive guide to database performance optimization, covering query optimization, indexing strategies, system tuning, and architectural considerations for high-performance database systems.">
<meta name="keywords" content="Database, Performance, Optimization, SQL, Indexing, technology, programming, web development, hugo, ÊäÄÊúØ, ÁºñÁ®ã, ÁΩëÁ´ôÂºÄÂèë">
<meta name="author" content="Database Expert">


<meta property="og:title" content="Database Performance Optimization Strategies: From Query Tuning to System Architecture">
<meta property="og:description" content="A comprehensive guide to database performance optimization, covering query optimization, indexing strategies, system tuning, and architectural considerations for high-performance database systems.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.dishuihengxin.com/posts/database-performance-optimization/">
<meta property="og:site_name" content="Êª¥Ê∞¥ÊÅíÂøÉ">
<meta property="og:locale" content="zh">




    



<meta property="og:image" content="https://www.dishuihengxin.com/images/logo.png">
<meta property="og:image:alt" content="Database Performance Optimization Strategies: From Query Tuning to System Architecture">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Database Performance Optimization Strategies: From Query Tuning to System Architecture">
<meta name="twitter:description" content="A comprehensive guide to database performance optimization, covering query optimization, indexing strategies, system tuning, and architectural considerations for high-performance database systems.">

<meta name="twitter:site" content="@dishuihengxin">
<meta name="twitter:creator" content="@dishuihengxin">


<meta name="twitter:image" content="https://www.dishuihengxin.com/images/logo.png">




<meta property="article:published_time" content="2025-12-31T22:00:00&#43;08:00">

<meta property="article:modified_time" content="2025-12-31T22:00:00&#43;08:00">


<meta property="article:author" content="Database Expert">


<meta property="article:section" content="Database">


<meta property="article:tag" content="Database">

<meta property="article:tag" content="Performance">

<meta property="article:tag" content="Optimization">

<meta property="article:tag" content="SQL">

<meta property="article:tag" content="Indexing">




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "name": "Database Performance Optimization Strategies: From Query Tuning to System Architecture",
  "headline": "Database Performance Optimization Strategies: From Query Tuning to System Architecture",
  "description": "A comprehensive guide to database performance optimization, covering query optimization, indexing strategies, system tuning, and architectural considerations for high-performance database systems.",
  "url": "https:\/\/www.dishuihengxin.com\/posts\/database-performance-optimization\/",
  
  "datePublished": "2025-12-31T22:00:00\u002b08:00",
  
  "dateModified": "2025-12-31T22:00:00\u002b08:00",
  
  "author": {
    "@type": "Person",
    "name": "Database Expert"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Êª¥Ê∞¥ÊÅíÂøÉ",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.dishuihengxin.com\/images\/logo.png"
    }
  },
  
  "image": {
    "@type": "ImageObject",
    "url": "https:\/\/www.dishuihengxin.com\/images\/logo.png"
  },
  
  
  "articleSection": ["Database"],
  
  
  "keywords": ["Database", "Performance", "Optimization", "SQL", "Indexing"],
  
  "wordCount":  7314 ,
  "timeRequired": "PT35M",
  
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/www.dishuihengxin.com\/posts\/database-performance-optimization\/"
  }
}
</script>






<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "È¶ñÈ°µ",
      "item": "https:\/\/www.dishuihengxin.com\/"
    }
    
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": "Posts",
      "item": "https:\/\/www.dishuihengxin.com\//posts/"
    }
    
    
    ,{
      "@type": "ListItem",
      "position": 3,
      "name": "Database Performance Optimization Strategies: From Query Tuning to System Architecture",
      "item": "https:\/\/www.dishuihengxin.com\/posts\/database-performance-optimization\/"
    }
    
  ]
}
</script>



<link rel="canonical" href="https://www.dishuihengxin.com/posts/database-performance-optimization/">






<meta name="robots" content="index, follow">



<meta name="theme-color" content="#3B82F6">
<meta name="msapplication-TileColor" content="#3B82F6">











<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>



<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">


<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">


    
    
    <link rel="alternate" hreflang="zh" href="https://www.dishuihengxin.com/posts/database-performance-optimization/">
    
    <link rel="alternate" hreflang="x-default" href="https://www.dishuihengxin.com/posts/database-performance-optimization/">

    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Êª¥Ê∞¥ÊÅíÂøÉ">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    
    

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">

    
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms,aspect-ratio"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            500: '#667eea',
                            600: '#5a67d8',
                            700: '#4c51bf'
                        }
                    },
                    animation: {
                        'gradient-shift': 'gradient-shift 3s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'circuit-flow': 'circuit-flow 3s ease-in-out infinite'
                    },
                    keyframes: {
                        'gradient-shift': {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' }
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '33%': { transform: 'translateY(-10px)' },
                            '66%': { transform: 'translateY(-5px)' }
                        },
                        'circuit-flow': {
                            '0%': { opacity: '0.3' },
                            '50%': { opacity: '0.8' },
                            '100%': { opacity: '0.3' }
                        }
                    }
                }
            }
        }
    </script>

    
    <style>
         
        [x-cloak] {
            display: none !important;
        }

         
        .tech-hero-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .tech-expertise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

         
        .bg-gradient-to-r.bg-clip-text.text-transparent {
            background-size: 200% 200% !important;
            animation: gradient-shift 3s ease infinite !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

         
        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

         
        @keyframes gradient-shift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

         
        .gradient-text-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%) !important;
            background-size: 200% 200% !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            animation: gradientShift 4s ease infinite !important;
        }

         
        @supports not ((-webkit-background-clip: text) or (background-clip: text)) {
            .gradient-text-primary {
                color: #3b82f6 !important;
                -webkit-text-fill-color: initial !important;
            }
        }

        .expertise-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .expertise-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .hero-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            position: relative;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }

        .dark .hero-container {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        .hero-content {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image:
                radial-gradient(circle at 20% 50%, #667eea 2px, transparent 2px),
                radial-gradient(circle at 80% 50%, #764ba2 2px, transparent 2px);
            background-size: 50px 50px;
            animation: circuit-flow 3s ease-in-out infinite;
        }

        .floating-element {
            animation: float 6s ease-in-out infinite;
        }

        .floating-element:nth-child(2) {
            animation-delay: -2s;
        }

        .floating-element:nth-child(3) {
            animation-delay: -4s;
        }

        .scroll-reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s ease;
        }

        .scroll-reveal.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        .heading-hero {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 0.75rem;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .dark .expertise-card {
            background: rgba(17, 24, 39, 0.8);
            border-color: rgba(75, 85, 99, 0.3);
        }

         
        .theme-toggle {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>

    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    
    <script>
        
        setTimeout(function () {
            if (typeof Alpine === 'undefined') {
                console.warn('Alpine.js failed to load, removing x-cloak attributes');
                document.querySelectorAll('[x-cloak]').forEach(function (el) {
                    el.removeAttribute('x-cloak');
                });
            }
        }, 3000);

        
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                if (typeof Alpine !== 'undefined' && Alpine.version) {
                    console.log('Alpine.js loaded successfully:', Alpine.version);
                } else {
                    console.warn('Alpine.js not detected, removing x-cloak attributes');
                    document.querySelectorAll('[x-cloak]').forEach(function (el) {
                        el.removeAttribute('x-cloak');
                    });
                }
            }, 1000);
        });
    </script>

    
    
    
    
    
    
    <link rel="stylesheet" href="/css/main.min.10e1a04b2dbaa9195f40fa651ee332db18278d0979ae7e51b0a82310921c25ea.css" 
        integrity="sha256-EOGgSy26qRlfQPplHuMy2xgnjQl5rn5RsKgjEJIcJeo=" crossorigin="anonymous" >
    

    
    
    
    
    
    
    <link rel="stylesheet" href="/css/code.min.d8113910e55a8bf3c2b00bff6664d767b1326c723f610ffdbb17db29b550c869.css" 
        integrity="sha256-2BE5EOVai/PCsAv/ZmTXZ7EybHI/YQ/9uxfbKbVQyGk=" crossorigin="anonymous" >
    



    
    
    
    
    
    
    <link rel="stylesheet" href="/css/article-content.min.1e7243d4c68581aed5ac49dbf65270186efd57f979274513bfe8e9b07aca9106.css" 
        integrity="sha256-HnJD1MaFga7VrEnb9lJwGG79V/l5J0UTv&#43;jpsHrKkQY=" crossorigin="anonymous" >
    

    
    
    
    
    
    
    <script src="/js/code.min.e908b2b60c4f45e49eac078432e3caeb2f68cd90bacf6655e1e2daeb7c033a61.js"  integrity="sha256-6QiytgxPReSerAeEMuPK6y9ozZC6z2ZV4eLa63wDOmE="
        crossorigin="anonymous"  defer></script>
    

    
    
    
    
    
    
    <link rel="stylesheet" href="/css/theme.min.dd2785de1340fb42994644dc99d93edb890756750d7144ab9b7aadaacbb01150.css" 
        integrity="sha256-3SeF3hNA&#43;0KZRkTcmdk&#43;24kHVnUNcUSrm3qtqsuwEVA=" crossorigin="anonymous" >
    

    
    
    
    
    
    <link rel="stylesheet" href="/css/responsive.min.f144a503e14c68cbc38822196c7658af9ab370ed84cae94de772479879f32f16.css" 
        integrity="sha256-8USlA&#43;FMaMvDiCIZbHZYr5qzcO2EyulN53JHmHnzLxY=" crossorigin="anonymous" >
    

    
    
    
    
    
    
    <link rel="stylesheet" href="/css/view-toggle.min.1a3ade9d6e3626af96631334fe0e34633672c976cdac345380fe83b1cf365d03.css" 
        integrity="sha256-GjrenW42Jq&#43;WYxM0/g40YzZyyXbNrDRTgP6Dsc82XQM=" crossorigin="anonymous" >
    

    
    
    
    
    
    
    <link rel="stylesheet" href="/css/hero-effects.min.cae12dabb387339d39793c685980b23d5568e5a2bad8336dcfacc86a4c84147b.css" 
        integrity="sha256-yuEtq7OHM505eTxoWYCyPVVo5aK62DNtz6zIakyEFHs=" crossorigin="anonymous" >
    

</head>

<body class="font-sans antialiased transition-all duration-500 overflow-x-hidden body-gradient-light">

    
    <div class="fixed inset-0 pointer-events-none z-0">
        <div
            class="absolute inset-0 bg-gradient-to-br from-blue-50/50 via-purple-50/30 to-pink-50/50 dark:from-gray-900/90 dark:via-blue-900/50 dark:to-purple-900/30">
        </div>
        <div
            class="absolute top-1/4 left-1/4 w-96 h-96 bg-gradient-to-r from-blue-400/20 to-purple-500/20 rounded-full blur-3xl animate-float">
        </div>
        <div
            class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-gradient-to-r from-purple-400/20 to-pink-500/20 rounded-full blur-3xl animate-pulse">
        </div>
        <div
            class="absolute top-3/4 left-1/2 w-64 h-64 bg-gradient-to-r from-cyan-400/15 to-blue-500/15 rounded-full blur-2xl animate-float animation-delay-2000">
        </div>
    </div>

    
    <div class="relative z-50">
        
<section x-data="{ 
            showNotification: false,
            notificationVersion: '2024-01-20', // Update this when notification content changes
            dismissDuration: 24 * 60 * 60 * 1000, // 24 hours in milliseconds
            
            init() {
                this.checkNotificationStatus();
            },
            
            checkNotificationStatus() {
                const dismissedData = localStorage.getItem('notification-dismissed');
                
                if (!dismissedData) {
                    // Never dismissed, show notification
                    this.showNotification = true;
                    return;
                }
                
                try {
                    const data = JSON.parse(dismissedData);
                    const currentTime = Date.now();
                    
                    // Check if notification version has changed (new content)
                    if (data.version !== this.notificationVersion) {
                        this.showNotification = true;
                        return;
                    }
                    
                    // Check if enough time has passed since dismissal
                    if (currentTime - data.timestamp > this.dismissDuration) {
                        this.showNotification = true;
                        return;
                    }
                    
                    // Still within dismiss period
                    this.showNotification = false;
                } catch (e) {
                    // Invalid data format, show notification
                    this.showNotification = true;
                }
            },
            
            dismissNotification() {
                this.showNotification = false;
                const dismissData = {
                    timestamp: Date.now(),
                    version: this.notificationVersion
                };
                localStorage.setItem('notification-dismissed', JSON.stringify(dismissData));
            }
         }" 
         x-show="showNotification" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform -translate-y-full"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform -translate-y-full"
         x-cloak
         class="fixed top-0 left-0 right-0 z-60 bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg"
         id="notification-section"
         role="banner"
         aria-label="ÈÄöÁü•Ê†è">
    
    <div class="w-full max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-2 overflow-hidden">
        <div class="flex items-center justify-between gap-2">
            
            <div class="flex items-center gap-2 flex-1 min-w-0 overflow-hidden">
                
                <div class="flex-shrink-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                    </svg>
                </div>
                
                
                <div class="flex-1 min-w-0 overflow-hidden">
                    <p class="text-xs sm:text-sm font-medium text-white truncate">
                        
                            üéâ Ê¨¢ËøéËÆøÈóÆÊàë‰ª¨ÁöÑÊäÄÊúØÂçöÂÆ¢ÔºÅËé∑ÂèñÊúÄÊñ∞ÁöÑÊäÄÊúØÊñáÁ´†ÂíåÂºÄÂèëËµÑÊ∫ê
                        
                    </p>
                </div>
                
                
                <div class="hidden sm:block flex-shrink-0">
                    <a href="/about" 
                       class="inline-flex items-center px-2 sm:px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-md text-xs sm:text-sm font-medium text-white transition-all duration-200 hover:scale-105 whitespace-nowrap">
                        
                            ‰∫ÜËß£Êõ¥Â§ö
                        
                        <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
            
            
            <div class="flex-shrink-0">
                <button @click="dismissNotification()" 
                        class="inline-flex items-center justify-center w-6 h-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-md transition-all duration-200 hover:scale-105"
                        aria-label="ÂÖ≥Èó≠ÈÄöÁü•"
                        title="ÂÖ≥Èó≠ÈÄöÁü•Ôºà24Â∞èÊó∂ÂêéÈáçÊñ∞ÊòæÁ§∫Ôºâ">
                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</section>


<script>
    
    
</script>
    </div>

    
    <a href="#main-content"
        class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 glass-card px-4 py-2 rounded-xl z-50 text-primary-600 dark:text-primary-400 font-medium">
        Ë∑≥ËΩ¨Âà∞‰∏ªË¶ÅÂÜÖÂÆπ
    </a>

    

    
    <div class="relative z-40">
        <section class="fixed left-0 right-0 z-55 transition-all duration-500" 
         x-data="{ 
             mobileMenuOpen: false, 
             searchOpen: false,
             scrolled: false,
             themeMenuOpen: false,
             notificationVisible: false,
             notificationVersion: '2024-01-20', // Must match notification-bar.html
             dismissDuration: 24 * 60 * 60 * 1000, // 24 hours in milliseconds
             
             checkNotificationStatus() {
                 const dismissedData = localStorage.getItem('notification-dismissed');
                 
                 if (!dismissedData) {
                     this.notificationVisible = true;
                     return;
                 }
                 
                 try {
                     const data = JSON.parse(dismissedData);
                     const currentTime = Date.now();
                     
                     // Check if notification version has changed
                     if (data.version !== this.notificationVersion) {
                         this.notificationVisible = true;
                         return;
                     }
                     
                     // Check if enough time has passed since dismissal
                     if (currentTime - data.timestamp > this.dismissDuration) {
                         this.notificationVisible = true;
                         return;
                     }
                     
                     this.notificationVisible = false;
                 } catch (e) {
                     this.notificationVisible = true;
                 }
             }
         }"
         x-init="
             // Force search to be closed immediately
             $nextTick(() => {
                 searchOpen = false;
             });
             
             // Check notification status on init
             checkNotificationStatus();
             
             window.addEventListener('scroll', () => {
                 scrolled = window.pageYOffset > 50;
             });
             
             // Watch for notification bar changes
             window.addEventListener('storage', () => {
                 checkNotificationStatus();
             });
         "
         :class="{
             'glass-nav shadow-2xl shadow-primary-500/20 border-b border-white/20 dark:border-gray-700/30': scrolled,
             'bg-transparent': !scrolled,
             'top-11': notificationVisible,
             'top-0': !notificationVisible
         }"
         role="navigation"
         aria-label="‰∏ªÂØºËà™">
    <nav>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            
            <div class="flex items-center">
                <a href="/" class="site-logo-container group flex items-center space-x-3">
                    
                    <div class="relative">
                        <div class="w-12 h-12 flex items-center justify-center transform group-hover:scale-110 transition-all duration-300">
                            <img src="/images/logo.png" 
                                 alt="Êª¥Ê∞¥ÊÅíÂøÉ Logo" 
                                 class="w-10 h-10 object-contain"
                                 loading="eager">
                        </div>
                    </div>
                    <div class="hidden sm:block">
                        <span class="site-title">
                            Êª¥Ê∞¥ÊÅíÂøÉ
                        </span>
                        <div class="site-subtitle">
                            ÊäÄÊúØÂàÜ‰∫´
                        </div>
                    </div>
                </a>
            </div>
            
            
            <div class="hidden md:flex items-center space-x-1 flex-1 justify-end mr-4">
                
                    
                        
                        <a href="/" 
                           class="nav-menu-item  text-gray-700 dark:text-gray-300 text-base">
                            <span class="relative z-10">È¶ñÈ°µ</span>
                        </a>
                    
                
                    
                        
                        <a href="/posts/" 
                           class="nav-menu-item  text-gray-700 dark:text-gray-300 text-base">
                            <span class="relative z-10">ÂçöÊñá</span>
                        </a>
                    
                
                    
                        
                        <div class="relative group" x-data="{ open: false }" @mouseenter="open = true" @mouseleave="open = false">
                            <button class="nav-menu-item dropdown-trigger  text-gray-700 dark:text-gray-300 text-base flex items-center gap-1"
                                    @click="open = !open">
                                <span class="relative z-10">DBA</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            
                            <div x-show="open"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 scale-95 translate-y-2"
                                 x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave-end="opacity-0 scale-95 translate-y-2"
                                 class="absolute left-0 mt-2 w-56 rounded-xl shadow-2xl backdrop-blur-xl bg-white/95 dark:bg-gray-800/95 border border-gray-200/50 dark:border-gray-700/50 overflow-hidden z-50"
                                 style="display: none;">
                                <div class="py-2">
                                    
                                        <a href="/tags/mysql/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üê¨</span>
                                                
                                                <div>
                                                    <div class="font-medium">MySQL</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">È´òÂèØÁî®Êû∂ÊûÑ ¬∑ ‰∏ª‰ªéÂ§çÂà∂ ¬∑ ÊÄßËÉΩË∞É‰ºò</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/postgresql/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üêò</span>
                                                
                                                <div>
                                                    <div class="font-medium">PostgreSQL</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ÊµÅÂ§çÂà∂ ¬∑ ÈÄªËæëÂ§çÂà∂ ¬∑ Êü•ËØ¢‰ºòÂåñ</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/oracle/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üî¥</span>
                                                
                                                <div>
                                                    <div class="font-medium">Oracle</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">RAC ¬∑ DataGuard ¬∑ RMAN Â§á‰ªΩ</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/tuning/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">‚ö°</span>
                                                
                                                <div>
                                                    <div class="font-medium">ÊÄßËÉΩË∞É‰ºò</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">SQL ‰ºòÂåñ ¬∑ Á¥¢ÂºïËÆæËÆ° ¬∑ ÊâßË°åËÆ°Âàí</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/backup/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üíæ</span>
                                                
                                                <div>
                                                    <div class="font-medium">Â§á‰ªΩÊÅ¢Â§ç</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Â§á‰ªΩÁ≠ñÁï• ¬∑ PITR ¬∑ ÁÅæÈöæÊÅ¢Â§ç</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                </div>
                            </div>
                        </div>
                    
                
                    
                        
                        <div class="relative group" x-data="{ open: false }" @mouseenter="open = true" @mouseleave="open = false">
                            <button class="nav-menu-item dropdown-trigger  text-gray-700 dark:text-gray-300 text-base flex items-center gap-1"
                                    @click="open = !open">
                                <span class="relative z-10">ËøêÁª¥</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            
                            <div x-show="open"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 scale-95 translate-y-2"
                                 x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave-end="opacity-0 scale-95 translate-y-2"
                                 class="absolute left-0 mt-2 w-56 rounded-xl shadow-2xl backdrop-blur-xl bg-white/95 dark:bg-gray-800/95 border border-gray-200/50 dark:border-gray-700/50 overflow-hidden z-50"
                                 style="display: none;">
                                <div class="py-2">
                                    
                                        <a href="/tags/linux/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üêß</span>
                                                
                                                <div>
                                                    <div class="font-medium">Linux ËøêÁª¥</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ÂÜÖÊ†∏Ë∞É‰ºò ¬∑ Á≥ªÁªüÁÆ°ÁêÜ ¬∑ Shell ËÑöÊú¨</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/monitoring/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üìä</span>
                                                
                                                <div>
                                                    <div class="font-medium">ÁõëÊéß‰ΩìÁ≥ª</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Prometheus ¬∑ Grafana ¬∑ ÂëäË≠¶ËßÑÂàô</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/automation/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">ü§ñ</span>
                                                
                                                <div>
                                                    <div class="font-medium">Ëá™Âä®ÂåñËøêÁª¥</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Ansible ¬∑ Terraform ¬∑ IaC</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/network/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üåê</span>
                                                
                                                <div>
                                                    <div class="font-medium">ÁΩëÁªúËøêÁª¥</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">TCP/IP ¬∑ Ë¥üËΩΩÂùáË°° ¬∑ ÁΩëÁªúÊéíÈöú</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/security/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üîí</span>
                                                
                                                <div>
                                                    <div class="font-medium">ÂÆâÂÖ®Âä†Âõ∫</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ÊùÉÈôêÁÆ°ÁêÜ ¬∑ Èò≤ÁÅ´Â¢ô ¬∑ ÂÆâÂÖ®ÂÆ°ËÆ°</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                </div>
                            </div>
                        </div>
                    
                
                    
                        
                        <div class="relative group" x-data="{ open: false }" @mouseenter="open = true" @mouseleave="open = false">
                            <button class="nav-menu-item dropdown-trigger  text-gray-700 dark:text-gray-300 text-base flex items-center gap-1"
                                    @click="open = !open">
                                <span class="relative z-10">‰∫ëÊû∂ÊûÑ</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            
                            <div x-show="open"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 scale-95 translate-y-2"
                                 x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave-end="opacity-0 scale-95 translate-y-2"
                                 class="absolute left-0 mt-2 w-56 rounded-xl shadow-2xl backdrop-blur-xl bg-white/95 dark:bg-gray-800/95 border border-gray-200/50 dark:border-gray-700/50 overflow-hidden z-50"
                                 style="display: none;">
                                <div class="py-2">
                                    
                                        <a href="/tags/aws/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">‚òÅÔ∏è</span>
                                                
                                                <div>
                                                    <div class="font-medium">AWS</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">EC2 ¬∑ RDS ¬∑ S3 ¬∑ Lambda</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/azure/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üåê</span>
                                                
                                                <div>
                                                    <div class="font-medium">Azure</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">VM ¬∑ SQL Database ¬∑ Blob Storage</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/aliyun/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">‚òÅÔ∏è</span>
                                                
                                                <div>
                                                    <div class="font-medium">ÈòøÈáå‰∫ë</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ECS ¬∑ RDS ¬∑ OSS ¬∑ ÂáΩÊï∞ËÆ°ÁÆó</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/architecture/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üèóÔ∏è</span>
                                                
                                                <div>
                                                    <div class="font-medium">Êû∂ÊûÑËÆæËÆ°</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ÂæÆÊúçÂä° ¬∑ È´òÂèØÁî® ¬∑ ÂºπÊÄß‰º∏Áº©</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/cloud-native/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üöÄ</span>
                                                
                                                <div>
                                                    <div class="font-medium">‰∫ëÂéüÁîü</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Serverless ¬∑ Service Mesh ¬∑ ‰∫ëÂéüÁîüÂ∫îÁî®</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                </div>
                            </div>
                        </div>
                    
                
                    
                        
                        <div class="relative group" x-data="{ open: false }" @mouseenter="open = true" @mouseleave="open = false">
                            <button class="nav-menu-item dropdown-trigger  text-gray-700 dark:text-gray-300 text-base flex items-center gap-1"
                                    @click="open = !open">
                                <span class="relative z-10">DevOps</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            
                            <div x-show="open"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 scale-95 translate-y-2"
                                 x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                 x-transition:leave-end="opacity-0 scale-95 translate-y-2"
                                 class="absolute left-0 mt-2 w-56 rounded-xl shadow-2xl backdrop-blur-xl bg-white/95 dark:bg-gray-800/95 border border-gray-200/50 dark:border-gray-700/50 overflow-hidden z-50"
                                 style="display: none;">
                                <div class="py-2">
                                    
                                        <a href="/tags/cicd/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üîÑ</span>
                                                
                                                <div>
                                                    <div class="font-medium">CI/CD</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Jenkins ¬∑ GitLab CI ¬∑ GitHub Actions</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/docker/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üê≥</span>
                                                
                                                <div>
                                                    <div class="font-medium">Docker</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ÈïúÂÉèÊûÑÂª∫ ¬∑ ÂÆπÂô®ÁºñÊéí ¬∑ ÊúÄ‰Ω≥ÂÆûË∑µ</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/kubernetes/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">‚ò∏Ô∏è</span>
                                                
                                                <div>
                                                    <div class="font-medium">Kubernetes</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Pod ¬∑ Service ¬∑ Ingress ¬∑ Helm</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/gitops/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üîÄ</span>
                                                
                                                <div>
                                                    <div class="font-medium">GitOps</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ArgoCD ¬∑ Flux ¬∑ Â£∞ÊòéÂºèÈÉ®ÁΩ≤</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                        <a href="/tags/observability/" 
                                           class="dropdown-item block px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 transition-all duration-200 ">
                                            <div class="flex items-center gap-3">
                                                
                                                    <span class="text-lg">üëÅÔ∏è</span>
                                                
                                                <div>
                                                    <div class="font-medium">ÂèØËßÇÊµãÊÄß</div>
                                                    
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Êó•Âøó ¬∑ ÊåáÊ†á ¬∑ ÈìæË∑ØËøΩË∏™</div>
                                                    
                                                </div>
                                            </div>
                                        </a>
                                    
                                </div>
                            </div>
                        </div>
                    
                
                    
                        
                        <a href="/about/" 
                           class="nav-menu-item  text-gray-700 dark:text-gray-300 text-base">
                            <span class="relative z-10">ÂÖ≥‰∫é</span>
                        </a>
                    
                
            </div>
            
            
            <div class="flex items-center space-x-3">
                
                <button @click="toggleTheme()" 
                         @keydown.enter="toggleTheme()"
                         @keydown.space.prevent="toggleTheme()"
                         class="nav-action-btn group focus:outline-none"
                         data-toggle="dark-mode"
                         type="button"
                         role="switch"
                         :aria-checked="document.documentElement.classList.contains('dark') ? 'true' : 'false'"
                         aria-label="ÂàáÊç¢‰∏ªÈ¢ò"
                         :aria-describedby="document.documentElement.classList.contains('dark') ? 'theme-dark' : 'theme-light'">
                    <svg class="text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                
                
                <a href="/search/" 
                   class="nav-action-btn group focus:outline-none"
                   aria-label="ÊêúÁ¥¢">
                    <svg class="text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </a>
                
                
                
                
                    
                
                    
                    
                    
                    
                    
                        
                        
                            
                        
                    
                    
                    <a href="/en/posts/database-performance-optimization/" 
                       hreflang="en"
                       class="lang-switcher flex items-center space-x-2 text-gray-600 dark:text-gray-400 group"
                       aria-label="Switch to English">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span>EN</span>
                    </a>
                    
                
                
                
                
                <button @click="mobileMenuOpen = !mobileMenuOpen" 
                         @keydown.enter="mobileMenuOpen = !mobileMenuOpen"
                         @keydown.space.prevent="mobileMenuOpen = !mobileMenuOpen"
                         class="mobile-menu-toggle md:hidden p-2 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                         type="button"
                         :aria-label="mobileMenuOpen ? 'ÂÖ≥Èó≠ËèúÂçï' : 'ÊâìÂºÄËèúÂçï'"
                         :aria-expanded="mobileMenuOpen ? 'true' : 'false'"
                         aria-controls="mobile-menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        
        <div x-show="mobileMenuOpen" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="transform opacity-0 scale-95 translate-y-2"
             x-transition:enter-end="transform opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="transform opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="transform opacity-0 scale-95 translate-y-2"
             id="mobile-menu"
             class="mobile-menu-container md:hidden"
             role="menu"
             aria-label="ÁßªÂä®Á´ØÂØºËà™ËèúÂçï">
            <div class="px-4 pt-4 pb-6 space-y-2">
                
                    
                        
                        <a href="/" 
                           class="mobile-nav-item block text-gray-700 dark:text-gray-300 ">
                            È¶ñÈ°µ
                        </a>
                    
                
                    
                        
                        <a href="/posts/" 
                           class="mobile-nav-item block text-gray-700 dark:text-gray-300 ">
                            ÂçöÊñá
                        </a>
                    
                
                    
                        
                        <div x-data="{ mobileSubOpen: false }" class="space-y-1">
                            <button @click="mobileSubOpen = !mobileSubOpen"
                                    class="mobile-nav-item w-full flex items-center justify-between text-gray-700 dark:text-gray-300 ">
                                <span>DBA</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': mobileSubOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="mobileSubOpen" 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 -translate-y-1"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="pl-4 space-y-1"
                                 style="display: none;">
                                
                                    <a href="/tags/mysql/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üê¨</span>MySQL
                                    </a>
                                
                                    <a href="/tags/postgresql/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üêò</span>PostgreSQL
                                    </a>
                                
                                    <a href="/tags/oracle/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üî¥</span>Oracle
                                    </a>
                                
                                    <a href="/tags/tuning/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">‚ö°</span>ÊÄßËÉΩË∞É‰ºò
                                    </a>
                                
                                    <a href="/tags/backup/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üíæ</span>Â§á‰ªΩÊÅ¢Â§ç
                                    </a>
                                
                            </div>
                        </div>
                    
                
                    
                        
                        <div x-data="{ mobileSubOpen: false }" class="space-y-1">
                            <button @click="mobileSubOpen = !mobileSubOpen"
                                    class="mobile-nav-item w-full flex items-center justify-between text-gray-700 dark:text-gray-300 ">
                                <span>ËøêÁª¥</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': mobileSubOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="mobileSubOpen" 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 -translate-y-1"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="pl-4 space-y-1"
                                 style="display: none;">
                                
                                    <a href="/tags/linux/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üêß</span>Linux ËøêÁª¥
                                    </a>
                                
                                    <a href="/tags/monitoring/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üìä</span>ÁõëÊéß‰ΩìÁ≥ª
                                    </a>
                                
                                    <a href="/tags/automation/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">ü§ñ</span>Ëá™Âä®ÂåñËøêÁª¥
                                    </a>
                                
                                    <a href="/tags/network/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üåê</span>ÁΩëÁªúËøêÁª¥
                                    </a>
                                
                                    <a href="/tags/security/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üîí</span>ÂÆâÂÖ®Âä†Âõ∫
                                    </a>
                                
                            </div>
                        </div>
                    
                
                    
                        
                        <div x-data="{ mobileSubOpen: false }" class="space-y-1">
                            <button @click="mobileSubOpen = !mobileSubOpen"
                                    class="mobile-nav-item w-full flex items-center justify-between text-gray-700 dark:text-gray-300 ">
                                <span>‰∫ëÊû∂ÊûÑ</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': mobileSubOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="mobileSubOpen" 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 -translate-y-1"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="pl-4 space-y-1"
                                 style="display: none;">
                                
                                    <a href="/tags/aws/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">‚òÅÔ∏è</span>AWS
                                    </a>
                                
                                    <a href="/tags/azure/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üåê</span>Azure
                                    </a>
                                
                                    <a href="/tags/aliyun/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">‚òÅÔ∏è</span>ÈòøÈáå‰∫ë
                                    </a>
                                
                                    <a href="/tags/architecture/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üèóÔ∏è</span>Êû∂ÊûÑËÆæËÆ°
                                    </a>
                                
                                    <a href="/tags/cloud-native/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üöÄ</span>‰∫ëÂéüÁîü
                                    </a>
                                
                            </div>
                        </div>
                    
                
                    
                        
                        <div x-data="{ mobileSubOpen: false }" class="space-y-1">
                            <button @click="mobileSubOpen = !mobileSubOpen"
                                    class="mobile-nav-item w-full flex items-center justify-between text-gray-700 dark:text-gray-300 ">
                                <span>DevOps</span>
                                <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': mobileSubOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="mobileSubOpen" 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 -translate-y-1"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="pl-4 space-y-1"
                                 style="display: none;">
                                
                                    <a href="/tags/cicd/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üîÑ</span>CI/CD
                                    </a>
                                
                                    <a href="/tags/docker/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üê≥</span>Docker
                                    </a>
                                
                                    <a href="/tags/kubernetes/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">‚ò∏Ô∏è</span>Kubernetes
                                    </a>
                                
                                    <a href="/tags/gitops/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üîÄ</span>GitOps
                                    </a>
                                
                                    <a href="/tags/observability/" 
                                       class="mobile-nav-subitem block py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors ">
                                        <span class="mr-2">üëÅÔ∏è</span>ÂèØËßÇÊµãÊÄß
                                    </a>
                                
                            </div>
                        </div>
                    
                
                    
                        
                        <a href="/about/" 
                           class="mobile-nav-item block text-gray-700 dark:text-gray-300 ">
                            ÂÖ≥‰∫é
                        </a>
                    
                
            </div>
        </div>
    </div>
    

    </nav>
</section>


<script>

function toggleTheme() {
    if (window.themeManager) {
        window.themeManager.toggleTheme();
    } else {
        
        const html = document.documentElement;
        const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        if (newTheme === 'dark') {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }
        
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }
}


function updateThemeIcon(theme) {
    const button = document.querySelector('[data-toggle="dark-mode"]');
    if (button) {
        const svg = button.querySelector('svg path');
        if (svg) {
            if (theme === 'dark') {
                
                svg.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
            } else {
                
                svg.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
            }
        }
    }
}


document.addEventListener('alpine:init', () => {
    Alpine.data('nav', () => ({
        init() {
            
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }

            
            if (window.location.pathname.includes('/search')) {
                window['searchManager'] = new SearchManager();
            }
        }
    }));
});


document.addEventListener('DOMContentLoaded', function() {
    
    setTimeout(() => {
        if (!window.themeManager) {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            
            const html = document.documentElement;
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            updateThemeIcon(theme);
        }
    }, 100);
    
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
    </div>

    
    <main id="main-content" class="relative z-10 min-h-screen transition-all duration-500"
        x-data="{ notificationVisible: !localStorage.getItem('notification-dismissed') }" x-init="
              window.addEventListener('storage', () => {
                  notificationVisible = !localStorage.getItem('notification-dismissed');
              });
          " :class="{
              'pt-28': notificationVisible,
              'pt-16': !notificationVisible
          }">
        

<div
    class="relative bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-gray-900 dark:via-indigo-900 dark:to-purple-900 py-12 mb-8">
    <div class="absolute inset-0 opacity-10">
        <div class="absolute inset-0 bg-pattern-dots">
        </div>
    </div>
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl">
            
            <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400 mb-4">
                <a href="/"
                    class="hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">
                    È¶ñÈ°µ
                </a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                
                
                <a href="/categories/database"
                    class="hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">
                    Database
                </a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                
                
                <span class="text-gray-500 dark:text-gray-500">Database Performance Optimization Strategies: From Query Tuning to System Architecture</span>
            </nav>

            
            
            <div class="flex flex-wrap gap-2 mb-4">
                
                <a href="/categories/database"
                    class="inline-block px-3 py-1 text-sm font-medium text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900/30 rounded-full hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors duration-200">
                    Database
                </a>
                
            </div>
            

            
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
                Database Performance Optimization Strategies: From Query Tuning to System Architecture
            </h1>

            
            <div class="flex flex-wrap items-center gap-6 text-sm text-gray-600 dark:text-gray-400">
                
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>Âçö‰∏ª</span>
                </div>

                
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <time datetime="2025-12-31">
                        2025-12-31
                    </time>
                </div>

                
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>35 ÂàÜÈíü</span>
                </div>

                
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span>7314 Â≠ó</span>
                </div>

                
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                        </path>
                    </svg>
                    <span id="view-count">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-8">
        
        <article class="min-w-0 overflow-hidden">
            
            

            
            
            
            
            
            

            <div
                class="ai-summary bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-6 mb-8 border border-blue-200 dark:border-blue-700/50 shadow-sm">
                
                <div class="flex items-center mb-4">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                            </path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                        AI ÂØºËØª
                    </h3>
                </div>

                
                <div class="prose prose-blue max-w-none dark:prose-invert">
                    
                    <p class="text-gray-600 dark:text-gray-300">
                        
                        Ê∑±ÂàªÁêÜËß£ÂíåÂáÜÁ°ÆÊääÊè°"Database Performance Optimization Strategies: From Query Tuning to System Architecture"Ëøô‰∏ÄÈáçË¶ÅÊ¶ÇÂøµÁöÑÊ†∏ÂøÉË¶Å‰πâÔºåÊú¨Êñá‰ªéÁêÜËÆ∫Âü∫Á°Ä„ÄÅÂÆûË∑µÂ∫îÁî®ÂíåÂèëÂ±ïÂâçÊôØÁ≠âÂ§ö‰∏™Áª¥Â∫¶ËøõË°å‰∫ÜÁ≥ªÁªüÊÄßÈòêËø∞Ôºå‰∏∫ËØªËÄÖÊèê‰æõ‰∫ÜÂÖ®Èù¢ËÄåÊ∑±ÂÖ•ÁöÑÂàÜÊûêËßÜËßí„ÄÇ
                        
                    </p>
                    
                </div>

                
                <div class="mt-4 pt-3 border-t border-blue-200 dark:border-blue-700/50">
                    <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ÂÜÖÂÆπÁî±AIÊô∫ËÉΩÁîüÊàê
                    </p>
                </div>
            </div>
            

            
            <div class="article-content prose prose-lg max-w-none overflow-hidden">
                <h1 id="database-performance-optimization-strategies-from-query-tuning-to-system-architecture">Database Performance Optimization Strategies: From Query Tuning to System Architecture</h1>
<p>Database performance optimization is a critical aspect of modern application development. As data volumes grow and user expectations increase, the ability to efficiently query and manipulate data becomes paramount. This comprehensive guide explores various strategies and techniques for optimizing database performance, from basic query tuning to advanced architectural considerations.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="/posts/database-performance-optimization/#performance-analysis-and-monitoring">Performance Analysis and Monitoring</a></li>
<li><a href="/posts/database-performance-optimization/#query-optimization-techniques">Query Optimization Techniques</a></li>
<li><a href="/posts/database-performance-optimization/#indexing-strategies">Indexing Strategies</a></li>
<li><a href="/posts/database-performance-optimization/#database-schema-design">Database Schema Design</a></li>
<li><a href="/posts/database-performance-optimization/#system-level-optimization">System-Level Optimization</a></li>
<li><a href="/posts/database-performance-optimization/#caching-strategies">Caching Strategies</a></li>
<li><a href="/posts/database-performance-optimization/#partitioning-and-sharding">Partitioning and Sharding</a></li>
<li><a href="/posts/database-performance-optimization/#monitoring-and-alerting">Monitoring and Alerting</a></li>
</ol>
<h2 id="performance-analysis-and-monitoring">Performance Analysis and Monitoring</h2>
<h3 id="1-performance-metrics-collection">1. Performance Metrics Collection</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># src/monitoring/performance_monitor.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">psutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pymysql</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">psycopg2</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QueryMetrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_text</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">execution_time</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">rows_examined</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">rows_returned</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpu_usage</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory_usage</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">    <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemMetrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpu_percent</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory_percent</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">disk_io_read</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">disk_io_write</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">network_io_sent</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">network_io_recv</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">active_connections</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">slow_queries</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DatabasePerformanceMonitor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logging</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Metrics storage</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">system_metrics</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Performance thresholds</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">slow_query_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slow_query_threshold&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># seconds</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu_threshold&#39;</span><span class="p">,</span> <span class="mf">80.0</span><span class="p">)</span>  <span class="c1"># percent</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">memory_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_threshold&#39;</span><span class="p">,</span> <span class="mf">85.0</span><span class="p">)</span>  <span class="c1"># percent</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Database connections</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">db_connections</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_connections</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Monitoring state</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Setup logging configuration&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;PerformanceMonitor&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;performance_monitor.log&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_initialize_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Initialize database connections&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">db_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;databases&#39;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">db_type</span> <span class="o">=</span> <span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">db_name</span> <span class="o">=</span> <span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">host</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">port</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">user</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">password</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">database</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf8mb4&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">host</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">port</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">user</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">password</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">database</span><span class="o">=</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">db_connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;connection&#39;</span><span class="p">:</span> <span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">db_type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">db_config</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Connected to </span><span class="si">{</span><span class="n">db_type</span><span class="si">}</span><span class="s2"> database: </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Failed to connect to </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Start performance monitoring&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;Monitoring is already active&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitoring_loop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Performance monitoring started&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Stop performance monitoring&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Performance monitoring stopped&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_monitoring_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Main monitoring loop&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Collect system metrics</span>
</span></span><span class="line"><span class="cl">                <span class="n">system_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_system_metrics</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">system_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">system_metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Collect database metrics</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">db_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_collect_database_metrics</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">db_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Check for performance issues</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_check_performance_alerts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Sleep for monitoring interval</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monitoring_interval&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error in monitoring loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_collect_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SystemMetrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Collect system-level metrics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># CPU and Memory</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpu_percent</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Disk I/O</span>
</span></span><span class="line"><span class="cl">        <span class="n">disk_io</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_io_counters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Network I/O</span>
</span></span><span class="line"><span class="cl">        <span class="n">network_io</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_io_counters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Database connections (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">active_connections</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_get_active_connections</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">db_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">db_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_connections</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Slow queries count</span>
</span></span><span class="line"><span class="cl">        <span class="n">slow_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_recent_slow_queries</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SystemMetrics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">cpu_percent</span><span class="o">=</span><span class="n">cpu_percent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">memory_percent</span><span class="o">=</span><span class="n">memory</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">disk_io_read</span><span class="o">=</span><span class="n">disk_io</span><span class="o">.</span><span class="n">read_bytes</span> <span class="k">if</span> <span class="n">disk_io</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">disk_io_write</span><span class="o">=</span><span class="n">disk_io</span><span class="o">.</span><span class="n">write_bytes</span> <span class="k">if</span> <span class="n">disk_io</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">network_io_sent</span><span class="o">=</span><span class="n">network_io</span><span class="o">.</span><span class="n">bytes_sent</span> <span class="k">if</span> <span class="n">network_io</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">network_io_recv</span><span class="o">=</span><span class="n">network_io</span><span class="o">.</span><span class="n">bytes_recv</span> <span class="k">if</span> <span class="n">network_io</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">active_connections</span><span class="o">=</span><span class="n">active_connections</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">slow_queries</span><span class="o">=</span><span class="n">slow_queries</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_collect_database_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Collect database-specific metrics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conn</span> <span class="o">=</span> <span class="n">db_info</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">db_type</span> <span class="o">=</span> <span class="n">db_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_collect_mysql_metrics</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_collect_postgresql_metrics</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error collecting metrics for </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_collect_mysql_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Collect MySQL-specific metrics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Get slow query log entries</span>
</span></span><span class="line"><span class="cl">            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                SELECT sql_text, query_time, rows_examined, rows_sent, 
</span></span></span><span class="line"><span class="cl"><span class="s2">                       start_time, user_host
</span></span></span><span class="line"><span class="cl"><span class="s2">                FROM mysql.slow_log 
</span></span></span><span class="line"><span class="cl"><span class="s2">                WHERE start_time &gt; </span><span class="si">%s</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                ORDER BY start_time DESC
</span></span></span><span class="line"><span class="cl"><span class="s2">                LIMIT 100
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">query_metrics</span> <span class="o">=</span> <span class="n">QueryMetrics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_id</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">500</span><span class="p">],</span>  <span class="c1"># Truncate long queries</span>
</span></span><span class="line"><span class="cl">                    <span class="n">execution_time</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rows_examined</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rows_returned</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cpu_usage</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Not available in slow log</span>
</span></span><span class="line"><span class="cl">                    <span class="n">memory_usage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Not available in slow log</span>
</span></span><span class="line"><span class="cl">                    <span class="n">timestamp</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">database_name</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">user</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Get current process list for active queries</span>
</span></span><span class="line"><span class="cl">            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SHOW PROCESSLIST&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">active_queries</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">active_queries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">process</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">process</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="ow">and</span> <span class="n">process</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Sleep&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># This is an active query</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_metrics</span> <span class="o">=</span> <span class="n">QueryMetrics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">query_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_id</span><span class="p">(</span><span class="n">process</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">query_text</span><span class="o">=</span><span class="p">(</span><span class="n">process</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">500</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">execution_time</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">process</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rows_examined</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Not available in process list</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rows_returned</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Not available in process list</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cpu_usage</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">memory_usage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">database_name</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">user</span><span class="o">=</span><span class="n">process</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error collecting MySQL metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_collect_postgresql_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Collect PostgreSQL-specific metrics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Get active queries</span>
</span></span><span class="line"><span class="cl">            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                SELECT query, state, query_start, usename, 
</span></span></span><span class="line"><span class="cl"><span class="s2">                       backend_start, state_change
</span></span></span><span class="line"><span class="cl"><span class="s2">                FROM pg_stat_activity 
</span></span></span><span class="line"><span class="cl"><span class="s2">                WHERE state = &#39;active&#39; 
</span></span></span><span class="line"><span class="cl"><span class="s2">                AND query NOT LIKE &#39;%pg_stat_activity%&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">execution_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">query_metrics</span> <span class="o">=</span> <span class="n">QueryMetrics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_id</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">500</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rows_examined</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Not directly available</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rows_returned</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Not directly available</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cpu_usage</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">memory_usage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">database_name</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">user</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Get query statistics from pg_stat_statements if available</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    SELECT query, calls, total_time, mean_time, rows
</span></span></span><span class="line"><span class="cl"><span class="s2">                    FROM pg_stat_statements 
</span></span></span><span class="line"><span class="cl"><span class="s2">                    WHERE last_exec &gt; </span><span class="si">%s</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                    ORDER BY total_time DESC
</span></span></span><span class="line"><span class="cl"><span class="s2">                    LIMIT 50
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),))</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_metrics</span> <span class="o">=</span> <span class="n">QueryMetrics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">query_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_id</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">query_text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">500</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">execution_time</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span>  <span class="c1"># Convert to seconds</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rows_examined</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rows_returned</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cpu_usage</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">memory_usage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">database_name</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;system&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># pg_stat_statements extension not available</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error collecting PostgreSQL metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_get_active_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get number of active connections&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conn</span> <span class="o">=</span> <span class="n">db_info</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">db_type</span> <span class="o">=</span> <span class="n">db_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SHOW STATUS LIKE &#39;Threads_connected&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SELECT count(*) FROM pg_stat_activity&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error getting active connections for </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;cursor&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_count_recent_slow_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Count slow queries in recent time window&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="mi">1</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span> <span class="ow">and</span> 
</span></span><span class="line"><span class="cl">               <span class="n">metric</span><span class="o">.</span><span class="n">execution_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_query_threshold</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_performance_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for performance issues and generate alerts&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">latest_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># CPU threshold alert</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">latest_metrics</span><span class="o">.</span><span class="n">cpu_percent</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_threshold</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send_alert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;HIGH_CPU&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;CPU usage is </span><span class="si">{</span><span class="n">latest_metrics</span><span class="o">.</span><span class="n">cpu_percent</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;exceeding threshold of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_threshold</span><span class="si">}</span><span class="s2">%&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Memory threshold alert</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">latest_metrics</span><span class="o">.</span><span class="n">memory_percent</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_threshold</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send_alert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;HIGH_MEMORY&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;Memory usage is </span><span class="si">{</span><span class="n">latest_metrics</span><span class="o">.</span><span class="n">memory_percent</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;exceeding threshold of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_threshold</span><span class="si">}</span><span class="s2">%&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Slow query alert</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">latest_metrics</span><span class="o">.</span><span class="n">slow_queries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send_alert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;SLOW_QUERIES&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;Detected </span><span class="si">{</span><span class="n">latest_metrics</span><span class="o">.</span><span class="n">slow_queries</span><span class="si">}</span><span class="s2"> slow queries in the last 5 minutes&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Send performance alert&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">alert_type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;WARNING&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;ALERT [</span><span class="si">{</span><span class="n">alert_type</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Here you could integrate with alerting systems like:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># - Email notifications</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># - Slack/Teams webhooks</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># - PagerDuty</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># - Custom monitoring systems</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_query_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Generate unique ID for query&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">query_text</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_performance_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get performance summary for specified time period&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Filter metrics by time</span>
</span></span><span class="line"><span class="cl">        <span class="n">recent_queries</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span> 
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">recent_system</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_metrics</span> 
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_queries</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">recent_system</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data for analysis&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Query analysis</span>
</span></span><span class="line"><span class="cl">        <span class="n">slow_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">recent_queries</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">execution_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_query_threshold</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">avg_execution_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">execution_time</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">recent_queries</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_queries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># System analysis</span>
</span></span><span class="line"><span class="cl">        <span class="n">avg_cpu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cpu_percent</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">recent_system</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">avg_memory</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">memory_percent</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">recent_system</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_connections</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">active_connections</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">recent_system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Top slow queries</span>
</span></span><span class="line"><span class="cl">        <span class="n">top_slow_queries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">slow_queries</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">execution_time</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;time_period_hours&#39;</span><span class="p">:</span> <span class="n">hours</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;total_queries&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_queries</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;slow_queries_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">slow_queries</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;slow_query_percentage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slow_queries</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_queries</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;average_execution_time&#39;</span><span class="p">:</span> <span class="n">avg_execution_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;average_cpu_usage&#39;</span><span class="p">:</span> <span class="n">avg_cpu</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;average_memory_usage&#39;</span><span class="p">:</span> <span class="n">avg_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;max_concurrent_connections&#39;</span><span class="p">:</span> <span class="n">max_connections</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;top_slow_queries&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;query_text&#39;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">query_text</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">execution_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">database_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">user</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">top_slow_queries</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">export_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Export collected metrics to file&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;query_metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_metrics</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;system_metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_metrics</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;export_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Unsupported format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Metrics exported to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Example configuration</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;databases&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;main_db&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;monitor_user&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;monitor_pass&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;production&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;analytics_db&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;monitor_user&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;monitor_pass&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;analytics&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;slow_query_threshold&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;cpu_threshold&#39;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;memory_threshold&#39;</span><span class="p">:</span> <span class="mf">85.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;monitoring_interval&#39;</span><span class="p">:</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create and start monitor</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span> <span class="o">=</span> <span class="n">DatabasePerformanceMonitor</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">monitor</span><span class="o">.</span><span class="n">start_monitoring</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Let it run for a while</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 minutes</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Get performance summary</span>
</span></span><span class="line"><span class="cl">        <span class="n">summary</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">get_performance_summary</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Performance Summary:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Export metrics</span>
</span></span><span class="line"><span class="cl">        <span class="n">monitor</span><span class="o">.</span><span class="n">export_metrics</span><span class="p">(</span><span class="s1">&#39;performance_metrics.json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">monitor</span><span class="o">.</span><span class="n">stop_monitoring</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="query-optimization-techniques">Query Optimization Techniques</h2>
<h3 id="1-sql-query-analyzer">1. SQL Query Analyzer</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># src/optimization/query_analyzer.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlparse.sql</span> <span class="kn">import</span> <span class="n">Statement</span><span class="p">,</span> <span class="n">Token</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlparse.tokens</span> <span class="kn">import</span> <span class="n">Keyword</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Punctuation</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OptimizationLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOW</span> <span class="o">=</span> <span class="s2">&#34;low&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="s2">&#34;medium&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HIGH</span> <span class="o">=</span> <span class="s2">&#34;high&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&#34;critical&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OptimizationSuggestion</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">level</span><span class="p">:</span> <span class="n">OptimizationLevel</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">original_query</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">optimized_query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_improvement</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">explanation</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SQLQueryAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_rules</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_select_star</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_missing_where_clause</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_function_in_where</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_or_conditions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_like_patterns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_subquery_optimization</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_join_conditions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_order_by_optimization</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_group_by_optimization</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_index_hints</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Analyze SQL query and provide optimization suggestions&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Parse the query</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsed</span> <span class="o">=</span> <span class="n">sqlparse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">query</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Syntax Error&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Query parsing failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;N/A&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Fix syntax errors before optimization&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply optimization rules</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_rules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">rule_suggestions</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">rule_suggestions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">suggestions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rule_suggestions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Log error but continue with other rules</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error in rule </span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_select_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for SELECT * usage&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bSELECT\s+\*\b&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Column Selection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Avoid SELECT * - specify only needed columns&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;10-50</span><span class="si">% r</span><span class="s2">eduction in I/O&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;SELECT * retrieves all columns, increasing network traffic and memory usage. &#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s2">&#34;Specify only the columns you actually need.&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_missing_where_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for missing WHERE clause in SELECT/UPDATE/DELETE&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">query_upper</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for SELECT without WHERE</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SELECT&#39;</span> <span class="ow">in</span> <span class="n">query_upper</span> <span class="ow">and</span> 
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;WHERE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_upper</span> <span class="ow">and</span> 
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;LIMIT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_upper</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;JOIN&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_upper</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Filtering&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;SELECT query without WHERE clause may scan entire table&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;90</span><span class="si">%+ r</span><span class="s2">eduction in execution time&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Add WHERE clause to filter rows and use indexes effectively&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for UPDATE/DELETE without WHERE</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;UPDATE&#39;</span> <span class="ow">in</span> <span class="n">query_upper</span> <span class="ow">or</span> <span class="s1">&#39;DELETE&#39;</span> <span class="ow">in</span> <span class="n">query_upper</span><span class="p">)</span> <span class="ow">and</span> 
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;WHERE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_upper</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Safety&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;UPDATE/DELETE without WHERE clause affects all rows&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Prevents accidental data modification&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Always use WHERE clause with UPDATE/DELETE to avoid modifying all rows&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_function_in_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for functions applied to columns in WHERE clause&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Common function patterns that prevent index usage</span>
</span></span><span class="line"><span class="cl">        <span class="n">function_patterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="sa">r</span><span class="s1">&#39;\bUPPER\s*\(\s*\w+\s*\)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sa">r</span><span class="s1">&#39;\bLOWER\s*\(\s*\w+\s*\)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sa">r</span><span class="s1">&#39;\bSUBSTRING\s*\(\s*\w+&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sa">r</span><span class="s1">&#39;\bDATE\s*\(\s*\w+\s*\)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sa">r</span><span class="s1">&#39;\bYEAR\s*\(\s*\w+\s*\)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sa">r</span><span class="s1">&#39;\bMONTH\s*\(\s*\w+\s*\)&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">function_patterns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Index Usage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Functions on columns in WHERE clause prevent index usage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;50-90</span><span class="si">% i</span><span class="s2">mprovement with proper indexing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Move functions to the right side of comparison or use functional indexes&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_or_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for OR conditions that might benefit from UNION&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Count OR conditions in WHERE clause</span>
</span></span><span class="line"><span class="cl">        <span class="n">where_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;WHERE\s+(.*?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                               <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">where_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">or_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bOR\b&#39;</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">or_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Query Structure&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Multiple OR conditions (</span><span class="si">{</span><span class="n">or_count</span><span class="si">}</span><span class="s2">) may benefit from UNION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;20-60</span><span class="si">% i</span><span class="s2">mprovement with proper indexing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Consider rewriting multiple OR conditions as UNION queries &#34;</span>
</span></span><span class="line"><span class="cl">                               <span class="s2">&#34;to better utilize indexes&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_like_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for inefficient LIKE patterns&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for leading wildcard patterns</span>
</span></span><span class="line"><span class="cl">        <span class="n">leading_wildcard</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;LIKE\s+[&#39;</span><span class="se">\&#34;</span><span class="s2">]%[^&#39;</span><span class="se">\&#34;</span><span class="s2">]*[&#39;</span><span class="se">\&#34;</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">leading_wildcard</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Pattern Matching&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;LIKE patterns starting with </span><span class="si">% c</span><span class="s2">annot use indexes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Consider full-text search or other alternatives&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Leading wildcards force full table scans. &#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s2">&#34;Consider full-text indexes or alternative search methods&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_subquery_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for subqueries that could be optimized&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for correlated subqueries</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;WHERE\s+\w+\s+IN\s*\(\s*SELECT&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Subquery Optimization&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;IN subquery might be optimized with JOIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;20-80</span><span class="si">% i</span><span class="s2">mprovement depending on data size&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Consider rewriting IN subqueries as JOINs for better performance&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for EXISTS subqueries</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;WHERE\s+EXISTS\s*\(\s*SELECT&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Subquery Optimization&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;EXISTS subquery detected - ensure proper indexing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Varies with indexing strategy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;EXISTS subqueries can be efficient but require proper indexing &#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s2">&#34;on correlated columns&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_join_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check JOIN conditions and types&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for CROSS JOINs or missing JOIN conditions</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;FROM\s+\w+\s*,\s*\w+&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;JOIN Optimization&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Comma-separated tables create CROSS JOIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Significant - prevents cartesian products&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Use explicit JOIN syntax with proper ON conditions &#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s2">&#34;to avoid cartesian products&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for JOIN without ON clause</span>
</span></span><span class="line"><span class="cl">        <span class="n">join_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+\s+)?JOIN\s+\w+(?!\s+ON)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">join_matches</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;JOIN Optimization&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;JOIN without ON clause creates cartesian product&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Critical - prevents query from running efficiently&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Always specify ON conditions for JOINs to define the relationship&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_order_by_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check ORDER BY optimization opportunities&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for ORDER BY without LIMIT</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ORDER BY&#39;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span> 
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;LIMIT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;TOP&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Sorting&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;ORDER BY without LIMIT sorts entire result set&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Consider adding LIMIT if appropriate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;If you only need top N results, add LIMIT to avoid sorting &#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s2">&#34;the entire result set&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_group_by_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check GROUP BY optimization opportunities&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for GROUP BY with ORDER BY on different columns</span>
</span></span><span class="line"><span class="cl">        <span class="n">group_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;GROUP\s+BY\s+([\w\s,]+)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">order_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ORDER\s+BY\s+([\w\s,]+)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">group_match</span> <span class="ow">and</span> <span class="n">order_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">order_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">order_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">group_cols</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">order_cols</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Grouping and Sorting&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;ORDER BY columns differ from GROUP BY columns&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Consider ordering by GROUP BY columns&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Ordering by GROUP BY columns can be more efficient &#34;</span>
</span></span><span class="line"><span class="cl">                               <span class="s2">&#34;as the data is already grouped&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_index_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Statement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationSuggestion</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Suggest potential indexing opportunities&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract WHERE conditions</span>
</span></span><span class="line"><span class="cl">        <span class="n">where_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;WHERE\s+(.*?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                               <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">where_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Find equality conditions</span>
</span></span><span class="line"><span class="cl">            <span class="n">eq_conditions</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\s*=\s*&#39;</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">eq_conditions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Indexing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Consider indexes on columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eq_conditions</span><span class="p">))</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Significant with proper indexing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;Equality conditions in WHERE clause benefit from indexes&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check JOIN conditions for indexing</span>
</span></span><span class="line"><span class="cl">        <span class="n">join_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;JOIN\s+\w+\s+ON\s+(\w+\.\w+)\s*=\s*(\w+\.\w+)&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                 <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">join_matches</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">join_columns</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="k">match</span> <span class="ow">in</span> <span class="n">join_matches</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">join_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="k">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OptimizationSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">level</span><span class="o">=</span><span class="n">OptimizationLevel</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span><span class="o">=</span><span class="s2">&#34;Indexing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Ensure indexes on JOIN columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">join_columns</span><span class="p">))</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">original_query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimized_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">estimated_improvement</span><span class="o">=</span><span class="s2">&#34;Critical for JOIN performance&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">explanation</span><span class="o">=</span><span class="s2">&#34;JOIN conditions require indexes on both sides for optimal performance&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">suggestions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">SQLQueryAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">test_queries</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        SELECT * FROM users u, orders o 
</span></span></span><span class="line"><span class="cl"><span class="s2">        WHERE UPPER(u.email) = &#39;TEST@EXAMPLE.COM&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">        ORDER BY u.created_date
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        SELECT user_id, name, email FROM users 
</span></span></span><span class="line"><span class="cl"><span class="s2">        WHERE status = &#39;active&#39; 
</span></span></span><span class="line"><span class="cl"><span class="s2">        AND (category = &#39;premium&#39; OR category = &#39;gold&#39; OR category = &#39;platinum&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">        ORDER BY created_date DESC
</span></span></span><span class="line"><span class="cl"><span class="s2">        LIMIT 10
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        UPDATE users SET last_login = NOW()
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        SELECT u.name, COUNT(o.id) as order_count
</span></span></span><span class="line"><span class="cl"><span class="s2">        FROM users u
</span></span></span><span class="line"><span class="cl"><span class="s2">        LEFT JOIN orders o ON u.id = o.user_id
</span></span></span><span class="line"><span class="cl"><span class="s2">        WHERE u.email LIKE &#39;%@gmail.com&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">        GROUP BY u.id, u.name
</span></span></span><span class="line"><span class="cl"><span class="s2">        ORDER BY order_count DESC
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_queries</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">=== Query </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> Analysis ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Query: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Optimization Suggestions (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span><span class="si">}</span><span class="s2">):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">suggestions</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Description: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Improvement: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">estimated_improvement</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Explanation: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">explanation</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">No optimization suggestions found.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="indexing-strategies">Indexing Strategies</h2>
<h3 id="1-index-recommendation-engine">1. Index Recommendation Engine</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># src/indexing/index_advisor.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IndexType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">BTREE</span> <span class="o">=</span> <span class="s2">&#34;btree&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HASH</span> <span class="o">=</span> <span class="s2">&#34;hash&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BITMAP</span> <span class="o">=</span> <span class="s2">&#34;bitmap&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PARTIAL</span> <span class="o">=</span> <span class="s2">&#34;partial&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">COMPOSITE</span> <span class="o">=</span> <span class="s2">&#34;composite&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">COVERING</span> <span class="o">=</span> <span class="s2">&#34;covering&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FUNCTIONAL</span> <span class="o">=</span> <span class="s2">&#34;functional&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IndexRecommendation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="p">:</span> <span class="n">IndexType</span>
</span></span><span class="line"><span class="cl">    <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 1-10, 10 being highest</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_benefit</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">creation_sql</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">rationale</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_size_mb</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QueryPattern</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">pattern_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_template</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">frequency</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">avg_execution_time</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">tables_accessed</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">where_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">join_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">order_by_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">group_by_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IndexAdvisor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mysql&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span> <span class="o">=</span> <span class="n">database_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logging</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Query patterns storage</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">query_patterns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">QueryPattern</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Table metadata</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">table_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Existing indexes</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">existing_indexes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Configuration</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">min_query_frequency</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">min_execution_time</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># seconds</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">max_index_columns</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Setup logging configuration&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;IndexAdvisor&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_query_workload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Analyze query workload and generate index recommendations&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 1: Extract query patterns</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_query_patterns</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 2: Analyze patterns for indexing opportunities</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Single column indexes</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recommend_single_column_indexes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Composite indexes</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recommend_composite_indexes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Covering indexes</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recommend_covering_indexes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Partial indexes</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recommend_partial_indexes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Step 3: Prioritize and filter recommendations</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prioritize_recommendations</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_extract_query_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Extract patterns from query workload&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pattern_counter</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">query_data</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">query_text</span> <span class="o">=</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;execution_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Normalize query to create pattern</span>
</span></span><span class="line"><span class="cl">            <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_query</span><span class="p">(</span><span class="n">query_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pattern_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pattern_id</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">pattern_counter</span><span class="p">[</span><span class="n">pattern_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query_text</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;normalized&#39;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="n">execution_time</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create QueryPattern objects</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern_id</span><span class="p">,</span> <span class="n">query_list</span> <span class="ow">in</span> <span class="n">pattern_counter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_query_frequency</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">representative_query</span> <span class="o">=</span> <span class="n">query_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;normalized&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_execution_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;execution_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">query_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">avg_execution_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_execution_time</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Analyze query structure</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_query_structure</span><span class="p">(</span><span class="n">representative_query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">pattern</span> <span class="o">=</span> <span class="n">QueryPattern</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">pattern_id</span><span class="o">=</span><span class="n">pattern_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">query_template</span><span class="o">=</span><span class="n">representative_query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">frequency</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">query_list</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">avg_execution_time</span><span class="o">=</span><span class="n">avg_execution_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">tables_accessed</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">where_columns</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;where_columns&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">join_columns</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;join_columns&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">order_by_columns</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;order_by_columns&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">group_by_columns</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;group_by_columns&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">query_patterns</span><span class="p">[</span><span class="n">pattern_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_normalize_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Normalize query by replacing literals with placeholders&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Remove extra whitespace</span>
</span></span><span class="line"><span class="cl">        <span class="n">normalized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Replace string literals</span>
</span></span><span class="line"><span class="cl">        <span class="n">normalized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;&#39;[^&#39;]*&#39;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#39;?&#39;&#34;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Replace numeric literals</span>
</span></span><span class="line"><span class="cl">        <span class="n">normalized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b\d+\b&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Convert to uppercase for consistency</span>
</span></span><span class="line"><span class="cl">        <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">normalized</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_pattern_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Generate unique pattern ID&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">normalized_query</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_analyze_query_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Analyze query structure to extract column usage&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;where_columns&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;join_columns&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;order_by_columns&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;group_by_columns&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract tables</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;FROM\s+(\w+)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;JOIN\s+(\w+)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">table_matches</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract WHERE columns</span>
</span></span><span class="line"><span class="cl">        <span class="n">where_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;WHERE\s+(.*?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                               <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">where_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Simple column extraction (can be improved)</span>
</span></span><span class="line"><span class="cl">            <span class="n">columns</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\s*[=&lt;&gt;!]&#39;</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;where_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract JOIN columns</span>
</span></span><span class="line"><span class="cl">        <span class="n">join_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ON\s+(\w+)\.(\w+)\s*=\s*(\w+)\.(\w+)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">match</span> <span class="ow">in</span> <span class="n">join_matches</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;join_columns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract ORDER BY columns</span>
</span></span><span class="line"><span class="cl">        <span class="n">order_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ORDER\s+BY\s+(.*?)(?:\s+LIMIT|$)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">order_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">order_clause</span> <span class="o">=</span> <span class="n">order_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">columns</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)&#39;</span><span class="p">,</span> <span class="n">order_clause</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;order_by_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract GROUP BY columns</span>
</span></span><span class="line"><span class="cl">        <span class="n">group_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;GROUP\s+BY\s+(.*?)(?:\s+ORDER\s+BY|\s+LIMIT|$)&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">group_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_clause</span> <span class="o">=</span> <span class="n">group_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">columns</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)&#39;</span><span class="p">,</span> <span class="n">group_clause</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;group_by_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">analysis</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recommend_single_column_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Recommend single column indexes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">column_usage</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Collect column usage statistics</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">where_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">column_usage</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;usage_type&#39;</span><span class="p">:</span> <span class="s1">&#39;where&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">order_by_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">column_usage</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;usage_type&#39;</span><span class="p">:</span> <span class="s1">&#39;order_by&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Generate recommendations</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">usages</span> <span class="ow">in</span> <span class="n">column_usage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usages</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Skip columns used in only one pattern</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Calculate priority based on usage frequency and execution time</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_frequency</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">usage</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_execution_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">usage</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">avg_execution_time</span> <span class="k">for</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usages</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">usages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">priority</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">total_frequency</span> <span class="o">*</span> <span class="n">avg_execution_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Determine table name (simplified)</span>
</span></span><span class="line"><span class="cl">            <span class="n">table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_table_name</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">usages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">table_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">recommendation</span> <span class="o">=</span> <span class="n">IndexRecommendation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">index_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;idx_</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">index_type</span><span class="o">=</span><span class="n">IndexType</span><span class="o">.</span><span class="n">BTREE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">estimated_benefit</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Improves </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">usages</span><span class="p">)</span><span class="si">}</span><span class="s2"> query patterns&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">creation_sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_index_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;idx_</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">column</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rationale</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Column &#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39; is frequently used in WHERE/ORDER BY clauses&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">query_patterns</span><span class="o">=</span><span class="p">[</span><span class="n">usage</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pattern_id</span> <span class="k">for</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usages</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">estimated_size_mb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_index_size</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="p">[</span><span class="n">column</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recommend_composite_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Recommend composite indexes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">where_columns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Consider combinations of WHERE columns</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">tables_accessed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">table_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">where_columns</span> 
</span></span><span class="line"><span class="cl">                               <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_columns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Order columns by selectivity (simplified heuristic)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ordered_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_columns_by_selectivity</span><span class="p">(</span><span class="n">table_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ordered_columns</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_index_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">index_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;idx_</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_composite_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ordered_columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        
</span></span><span class="line"><span class="cl">                        <span class="n">recommendation</span> <span class="o">=</span> <span class="n">IndexRecommendation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">index_type</span><span class="o">=</span><span class="n">IndexType</span><span class="o">.</span><span class="n">COMPOSITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">columns</span><span class="o">=</span><span class="n">ordered_columns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">priority</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pattern</span><span class="o">.</span><span class="n">frequency</span> <span class="o">//</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">estimated_benefit</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Optimizes multi-column WHERE conditions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">creation_sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_index_sql</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">ordered_columns</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">rationale</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Multiple columns used together in WHERE clause&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">query_patterns</span><span class="o">=</span><span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern_id</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                            <span class="n">estimated_size_mb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_index_size</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">ordered_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recommend_covering_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Recommend covering indexes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Only for high-frequency queries</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">tables_accessed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Get all columns accessed for this table</span>
</span></span><span class="line"><span class="cl">                <span class="n">accessed_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">accessed_columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">where_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">accessed_columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">order_by_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Remove table prefixes</span>
</span></span><span class="line"><span class="cl">                <span class="n">clean_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">accessed_columns</span> 
</span></span><span class="line"><span class="cl">                               <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_columns</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_index_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Order: WHERE columns first, then ORDER BY</span>
</span></span><span class="line"><span class="cl">                    <span class="n">where_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clean_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">where_columns</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">order_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clean_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">order_by_columns</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">where_cols</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">covering_columns</span> <span class="o">=</span> <span class="n">where_cols</span> <span class="o">+</span> <span class="n">order_cols</span>
</span></span><span class="line"><span class="cl">                    <span class="n">index_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;idx_</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_covering_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">covering_columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">recommendation</span> <span class="o">=</span> <span class="n">IndexRecommendation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">index_type</span><span class="o">=</span><span class="n">IndexType</span><span class="o">.</span><span class="n">COVERING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">columns</span><span class="o">=</span><span class="n">covering_columns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">priority</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pattern</span><span class="o">.</span><span class="n">frequency</span> <span class="o">//</span> <span class="mi">10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">estimated_benefit</span><span class="o">=</span><span class="s2">&#34;Eliminates table lookups (index-only scan)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">creation_sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_index_sql</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">covering_columns</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rationale</span><span class="o">=</span><span class="s2">&#34;Covers all columns needed for query execution&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">query_patterns</span><span class="o">=</span><span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern_id</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">estimated_size_mb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_index_size</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">covering_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recommend_partial_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Recommend partial indexes for filtered queries&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">recommendations</span>  <span class="c1"># Partial indexes mainly supported in PostgreSQL</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Look for queries with constant WHERE conditions</span>
</span></span><span class="line"><span class="cl">            <span class="n">query</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">query_template</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Find constant conditions (simplified)</span>
</span></span><span class="line"><span class="cl">            <span class="n">constant_conditions</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(\w+)\s*=\s*&#39;[^&#39;]*&#39;&#34;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">constant_conditions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">tables_accessed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">condition_col</span> <span class="ow">in</span> <span class="n">constant_conditions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># Create partial index for other columns when this condition is met</span>
</span></span><span class="line"><span class="cl">                        <span class="n">other_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">where_columns</span> 
</span></span><span class="line"><span class="cl">                                       <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">condition_col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">other_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">index_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;idx_</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">other_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_partial&#34;</span>
</span></span><span class="line"><span class="cl">                            
</span></span><span class="line"><span class="cl">                            <span class="n">recommendation</span> <span class="o">=</span> <span class="n">IndexRecommendation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                <span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">index_type</span><span class="o">=</span><span class="n">IndexType</span><span class="o">.</span><span class="n">PARTIAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">columns</span><span class="o">=</span><span class="n">other_columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># Limit to 2 columns</span>
</span></span><span class="line"><span class="cl">                                <span class="n">priority</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">pattern</span><span class="o">.</span><span class="n">frequency</span> <span class="o">//</span> <span class="mi">20</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="n">estimated_benefit</span><span class="o">=</span><span class="s2">&#34;Smaller index size for filtered data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">creation_sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_partial_index_sql</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">table</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">other_columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">condition_col</span>
</span></span><span class="line"><span class="cl">                                <span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="n">rationale</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Frequent queries with constant </span><span class="si">{</span><span class="n">condition_col</span><span class="si">}</span><span class="s2"> condition&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">query_patterns</span><span class="o">=</span><span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern_id</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="n">estimated_size_mb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_index_size</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">other_columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.3</span>
</span></span><span class="line"><span class="cl">                            <span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_prioritize_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IndexRecommendation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Prioritize and filter recommendations&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Remove duplicates</span>
</span></span><span class="line"><span class="cl">        <span class="n">unique_recommendations</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_recommendations</span> <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="n">unique_recommendations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">unique_recommendations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Sort by priority</span>
</span></span><span class="line"><span class="cl">        <span class="n">sorted_recommendations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_recommendations</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Filter out low-priority recommendations</span>
</span></span><span class="line"><span class="cl">        <span class="n">filtered_recommendations</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">sorted_recommendations</span> <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">filtered_recommendations</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>  <span class="c1"># Limit to top 20</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_infer_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Infer table name for a column&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple heuristic: use the most common table from patterns</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tables_accessed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">table_counter</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">table_counter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">table_counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_order_columns_by_selectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Order columns by estimated selectivity (most selective first)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simplified heuristic: assume shorter column names are more selective</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># In practice, you&#39;d use actual cardinality statistics</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_index_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Generate CREATE INDEX SQL&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;CREATE INDEX </span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns_str</span><span class="si">}</span><span class="s2">);&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span> <span class="o">==</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;CREATE INDEX </span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns_str</span><span class="si">}</span><span class="s2">);&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;CREATE INDEX </span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns_str</span><span class="si">}</span><span class="s2">);&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_partial_index_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">condition_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Generate partial index SQL (PostgreSQL)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;CREATE INDEX </span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns_str</span><span class="si">}</span><span class="s2">) WHERE </span><span class="si">{</span><span class="n">condition_column</span><span class="si">}</span><span class="s2"> IS NOT NULL;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_estimate_index_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Estimate index size in MB&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simplified estimation</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_size</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># Base size in MB</span>
</span></span><span class="line"><span class="cl">        <span class="n">column_factor</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">base_size</span> <span class="o">+</span> <span class="n">column_factor</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_table_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Set table metadata for better recommendations&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">table_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_existing_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Set existing indexes to avoid duplicates&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">existing_indexes</span> <span class="o">=</span> <span class="n">indexes</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">export_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Export recommendations to JSON file&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># This would be called after analyze_query_workload</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl">    <span class="n">advisor</span> <span class="o">=</span> <span class="n">IndexAdvisor</span><span class="p">(</span><span class="n">database_type</span><span class="o">=</span><span class="s1">&#39;mysql&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Sample query workload</span>
</span></span><span class="line"><span class="cl">    <span class="n">sample_queries</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="s2">&#34;SELECT * FROM users WHERE email = &#39;test@example.com&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="s2">&#34;SELECT name, email FROM users WHERE status = &#39;active&#39; AND created_date &gt; &#39;2023-01-01&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="s2">&#34;SELECT u.name, COUNT(o.id) FROM users u JOIN orders o ON u.id = o.user_id WHERE u.status = &#39;active&#39; GROUP BY u.id ORDER BY COUNT(o.id) DESC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="mi">25</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Simulate frequency</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze workload</span>
</span></span><span class="line"><span class="cl">    <span class="n">recommendations</span> <span class="o">=</span> <span class="n">advisor</span><span class="o">.</span><span class="n">analyze_query_workload</span><span class="p">(</span><span class="n">sample_queries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Display recommendations</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span><span class="si">}</span><span class="s2"> index recommendations:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">index_name</span><span class="si">}</span><span class="s2"> (Priority: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">priority</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Table: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Type: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">index_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Benefit: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">estimated_benefit</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Size: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">estimated_size_mb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   SQL: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">creation_sql</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   Rationale: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">rationale</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="database-schema-design">Database Schema Design</h2>
<h3 id="1-schema-optimization-analyzer">1. Schema Optimization Analyzer</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># src/schema/schema_analyzer.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SchemaIssueType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">NORMALIZATION</span> <span class="o">=</span> <span class="s2">&#34;normalization&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DENORMALIZATION</span> <span class="o">=</span> <span class="s2">&#34;denormalization&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DATA_TYPE</span> <span class="o">=</span> <span class="s2">&#34;data_type&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONSTRAINT</span> <span class="o">=</span> <span class="s2">&#34;constraint&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">RELATIONSHIP</span> <span class="o">=</span> <span class="s2">&#34;relationship&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SchemaIssue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">issue_type</span><span class="p">:</span> <span class="n">SchemaIssueType</span>
</span></span><span class="line"><span class="cl">    <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># LOW, MEDIUM, HIGH, CRITICAL</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">recommendation</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">impact</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SchemaAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logging</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;SchemaAnalyzer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SchemaIssue</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Analyze database schema and identify optimization opportunities&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">tables</span> <span class="o">=</span> <span class="n">schema_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tables&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_info</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Check data types</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_data_types</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_info</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Check normalization</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_normalization</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_info</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Check constraints</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_constraints</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_info</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Check relationships</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_relationships</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_info</span><span class="p">,</span> <span class="n">tables</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">issues</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_severity_weight</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">severity</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_data_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SchemaIssue</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for suboptimal data type choices&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">column_info</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_type</span> <span class="o">=</span> <span class="n">column_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Check for oversized VARCHAR</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;VARCHAR&#39;</span> <span class="ow">in</span> <span class="n">data_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">size_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;VARCHAR\((\d+)\)&#39;</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">size_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">DATA_TYPE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;VARCHAR(</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">) may be oversized&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Consider using TEXT for large text or smaller VARCHAR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Increased storage and memory usage&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Check for CHAR vs VARCHAR</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;CHAR(&#39;</span> <span class="ow">in</span> <span class="n">data_type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">column_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_code&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">DATA_TYPE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;LOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;CHAR used for variable-length data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Consider VARCHAR for variable-length strings&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Wasted storage space&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Check for inappropriate use of TEXT</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;TEXT&#39;</span> <span class="ow">and</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">DATA_TYPE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;TEXT used for short categorical data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Use ENUM or small VARCHAR instead&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Inefficient storage and indexing&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">issues</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SchemaIssue</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for normalization issues&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for repeated column patterns (potential denormalization)</span>
</span></span><span class="line"><span class="cl">        <span class="n">column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Look for address fields that could be normalized</span>
</span></span><span class="line"><span class="cl">        <span class="n">address_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">                         <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;street&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">])]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">address_fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">NORMALIZATION</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Multiple address fields in single table&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Consider creating separate address table&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Data redundancy and maintenance complexity&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for JSON/TEXT columns that might need normalization</span>
</span></span><span class="line"><span class="cl">        <span class="n">json_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">                       <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;JSON&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">                       <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">json_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">NORMALIZATION</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;LOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">column_name</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_columns</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;JSON/TEXT columns may contain structured data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Consider normalizing if data has consistent structure&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Limited query capabilities and indexing&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">issues</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SchemaIssue</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for missing or inappropriate constraints&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">        <span class="n">constraints</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for missing primary key</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_primary_key</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PRIMARY KEY&#39;</span> <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_primary_key</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">CONSTRAINT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;HIGH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Table lacks primary key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Add primary key constraint&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Poor performance and replication issues&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for email columns without format constraints</span>
</span></span><span class="line"><span class="cl">        <span class="n">email_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">email_col</span> <span class="ow">in</span> <span class="n">email_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_email_constraint</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">constraint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">email_col</span> <span class="ow">and</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definition&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_email_constraint</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">CONSTRAINT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">column_name</span><span class="o">=</span><span class="n">email_col</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Email column lacks format validation&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">recommendation</span><span class="o">=</span><span class="s2">&#34;Add CHECK constraint for email format&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Data quality issues&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">issues</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_check_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">                           <span class="n">all_tables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SchemaIssue</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Check for relationship issues&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;foreign_keys&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for potential foreign key columns without constraints</span>
</span></span><span class="line"><span class="cl">        <span class="n">potential_fk_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">                               <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">existing_fk_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">fk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">fk_col</span> <span class="ow">in</span> <span class="n">potential_fk_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">fk_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_fk_columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Check if referenced table exists</span>
</span></span><span class="line"><span class="cl">                <span class="n">referenced_table</span> <span class="o">=</span> <span class="n">fk_col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span>  <span class="c1"># Simple heuristic</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">referenced_table</span> <span class="ow">in</span> <span class="n">all_tables</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SchemaIssue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">issue_type</span><span class="o">=</span><span class="n">SchemaIssueType</span><span class="o">.</span><span class="n">RELATIONSHIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">severity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">column_name</span><span class="o">=</span><span class="n">fk_col</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Potential foreign key </span><span class="si">{</span><span class="n">fk_col</span><span class="si">}</span><span class="s2"> lacks constraint&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">recommendation</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Add foreign key constraint to </span><span class="si">{</span><span class="n">referenced_table</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">impact</span><span class="o">=</span><span class="s2">&#34;Referential integrity not enforced&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">issues</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_severity_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Convert severity to numeric weight for sorting&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;MEDIUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;LOW&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">SchemaAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Sample schema metadata</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema_metadata</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;INT&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(255)&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(1000)&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(100)&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(50)&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;zip&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;PRIMARY KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;foreign_keys&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;orders&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;INT&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;INT&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;DECIMAL(10,2)&#39;</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;foreign_keys&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">issues</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_schema</span><span class="p">(</span><span class="n">schema_metadata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span><span class="si">}</span><span class="s2"> schema issues:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">severity</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">column_name</span> <span class="ow">or</span> <span class="s1">&#39;TABLE&#39;</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Issue: </span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Recommendation: </span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">recommendation</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Impact: </span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">impact</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="system-level-optimization">System-Level Optimization</h2>
<h3 id="1-database-configuration-tuner">1. Database Configuration Tuner</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># src/tuning/db_config_tuner.sh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Database Configuration Tuner</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Analyzes system resources and generates optimized database configurations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -euo pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">cd</span> <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">/tuning.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">CONFIG_OUTPUT_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">/optimized_configs&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Logging function</span>
</span></span><span class="line"><span class="cl">log<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="k">$(</span>date <span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] </span><span class="nv">$*</span><span class="s2">&#34;</span> <span class="p">|</span> tee -a <span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># System information gathering</span>
</span></span><span class="line"><span class="cl">get_system_info<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Gathering system information...&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Memory information</span>
</span></span><span class="line"><span class="cl">    <span class="nv">TOTAL_MEMORY_KB</span><span class="o">=</span><span class="k">$(</span>grep MemTotal /proc/meminfo <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">TOTAL_MEMORY_GB</span><span class="o">=</span><span class="k">$((</span>TOTAL_MEMORY_KB <span class="o">/</span> <span class="m">1024</span> <span class="o">/</span> <span class="m">1024</span><span class="k">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># CPU information</span>
</span></span><span class="line"><span class="cl">    <span class="nv">CPU_CORES</span><span class="o">=</span><span class="k">$(</span>nproc<span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">CPU_MODEL</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&#34;model name&#34;</span> /proc/cpuinfo <span class="p">|</span> head -1 <span class="p">|</span> cut -d: -f2 <span class="p">|</span> xargs<span class="k">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Storage information</span>
</span></span><span class="line"><span class="cl">    <span class="nv">STORAGE_INFO</span><span class="o">=</span><span class="k">$(</span>df -h / <span class="p">|</span> tail -1<span class="k">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Network information</span>
</span></span><span class="line"><span class="cl">    <span class="nv">NETWORK_INTERFACES</span><span class="o">=</span><span class="k">$(</span>ip link show <span class="p">|</span> grep -E <span class="s2">&#34;^[0-9]+&#34;</span> <span class="p">|</span> awk -F: <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> xargs<span class="k">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;System Information:&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;  Memory: </span><span class="si">${</span><span class="nv">TOTAL_MEMORY_GB</span><span class="si">}</span><span class="s2">GB&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;  CPU Cores: </span><span class="si">${</span><span class="nv">CPU_CORES</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;  CPU Model: </span><span class="si">${</span><span class="nv">CPU_MODEL</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;  Storage: </span><span class="si">${</span><span class="nv">STORAGE_INFO</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;  Network Interfaces: </span><span class="si">${</span><span class="nv">NETWORK_INTERFACES</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># MySQL configuration optimization</span>
</span></span><span class="line"><span class="cl">optimize_mysql_config<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">memory_gb</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">cpu_cores</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">config_file</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONFIG_OUTPUT_DIR</span><span class="si">}</span><span class="s2">/mysql_optimized.cnf&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Generating optimized MySQL configuration...&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate memory allocations (conservative approach)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">innodb_buffer_pool</span><span class="o">=</span><span class="k">$((</span>memory_gb <span class="o">*</span> <span class="m">70</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span>  <span class="c1"># 70% of total memory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">query_cache_size</span><span class="o">=</span><span class="k">$((</span>memory_gb <span class="o">*</span> <span class="m">5</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span>     <span class="c1"># 5% of total memory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">tmp_table_size</span><span class="o">=</span><span class="k">$((</span>memory_gb <span class="o">*</span> <span class="m">2</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span>       <span class="c1"># 2% of total memory</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Ensure minimum values</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="nv">$innodb_buffer_pool</span> -lt <span class="m">1</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">innodb_buffer_pool</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="nv">$query_cache_size</span> -lt <span class="m">1</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">query_cache_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="nv">$tmp_table_size</span> -lt <span class="m">1</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">tmp_table_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    cat &gt; <span class="s2">&#34;</span><span class="nv">$config_file</span><span class="s2">&#34;</span> <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s"># Optimized MySQL Configuration
</span></span></span><span class="line"><span class="cl"><span class="s"># Generated on $(date)
</span></span></span><span class="line"><span class="cl"><span class="s"># System: ${memory_gb}GB RAM, ${cpu_cores} CPU cores
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[mysqld]
</span></span></span><span class="line"><span class="cl"><span class="s"># Basic Settings
</span></span></span><span class="line"><span class="cl"><span class="s">user = mysql
</span></span></span><span class="line"><span class="cl"><span class="s">pid-file = /var/run/mysqld/mysqld.pid
</span></span></span><span class="line"><span class="cl"><span class="s">socket = /var/run/mysqld/mysqld.sock
</span></span></span><span class="line"><span class="cl"><span class="s">port = 3306
</span></span></span><span class="line"><span class="cl"><span class="s">basedir = /usr
</span></span></span><span class="line"><span class="cl"><span class="s">datadir = /var/lib/mysql
</span></span></span><span class="line"><span class="cl"><span class="s">tmpdir = /tmp
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Memory Settings
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_buffer_pool_size = ${innodb_buffer_pool}G
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_buffer_pool_instances = $((cpu_cores &gt; 8 ? 8 : cpu_cores))
</span></span></span><span class="line"><span class="cl"><span class="s">query_cache_size = ${query_cache_size}G
</span></span></span><span class="line"><span class="cl"><span class="s">query_cache_type = 1
</span></span></span><span class="line"><span class="cl"><span class="s">tmp_table_size = ${tmp_table_size}G
</span></span></span><span class="line"><span class="cl"><span class="s">max_heap_table_size = ${tmp_table_size}G
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Connection Settings
</span></span></span><span class="line"><span class="cl"><span class="s">max_connections = $((cpu_cores * 50))
</span></span></span><span class="line"><span class="cl"><span class="s">max_connect_errors = 1000000
</span></span></span><span class="line"><span class="cl"><span class="s">thread_cache_size = $((cpu_cores * 2))
</span></span></span><span class="line"><span class="cl"><span class="s">table_open_cache = $((cpu_cores * 200))
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># InnoDB Settings
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_file_per_table = 1
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_flush_log_at_trx_commit = 2
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_log_file_size = 256M
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_log_buffer_size = 64M
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_flush_method = O_DIRECT
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_io_capacity = 1000
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_io_capacity_max = 2000
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_read_io_threads = $((cpu_cores / 2 &gt; 4 ? 4 : cpu_cores / 2))
</span></span></span><span class="line"><span class="cl"><span class="s">innodb_write_io_threads = $((cpu_cores / 2 &gt; 4 ? 4 : cpu_cores / 2))
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Query Cache
</span></span></span><span class="line"><span class="cl"><span class="s">query_cache_limit = 2M
</span></span></span><span class="line"><span class="cl"><span class="s">query_cache_min_res_unit = 2k
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Slow Query Log
</span></span></span><span class="line"><span class="cl"><span class="s">slow_query_log = 1
</span></span></span><span class="line"><span class="cl"><span class="s">slow_query_log_file = /var/log/mysql/slow.log
</span></span></span><span class="line"><span class="cl"><span class="s">long_query_time = 1
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Binary Logging
</span></span></span><span class="line"><span class="cl"><span class="s">log_bin = /var/log/mysql/mysql-bin.log
</span></span></span><span class="line"><span class="cl"><span class="s">binlog_format = ROW
</span></span></span><span class="line"><span class="cl"><span class="s">expire_logs_days = 7
</span></span></span><span class="line"><span class="cl"><span class="s">max_binlog_size = 100M
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Performance Schema
</span></span></span><span class="line"><span class="cl"><span class="s">performance_schema = ON
</span></span></span><span class="line"><span class="cl"><span class="s">performance_schema_max_table_instances = 400
</span></span></span><span class="line"><span class="cl"><span class="s">performance_schema_max_table_handles = 4000
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Security
</span></span></span><span class="line"><span class="cl"><span class="s">local_infile = 0
</span></span></span><span class="line"><span class="cl"><span class="s">skip_show_database
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[mysql]
</span></span></span><span class="line"><span class="cl"><span class="s">no-auto-rehash
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[mysqldump]
</span></span></span><span class="line"><span class="cl"><span class="s">quick
</span></span></span><span class="line"><span class="cl"><span class="s">quote-names
</span></span></span><span class="line"><span class="cl"><span class="s">max_allowed_packet = 16M
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;MySQL configuration saved to: </span><span class="nv">$config_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># PostgreSQL configuration optimization</span>
</span></span><span class="line"><span class="cl">optimize_postgresql_config<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">memory_gb</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">cpu_cores</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">config_file</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONFIG_OUTPUT_DIR</span><span class="si">}</span><span class="s2">/postgresql_optimized.conf&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Generating optimized PostgreSQL configuration...&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate memory allocations</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">shared_buffers</span><span class="o">=</span><span class="k">$((</span>memory_gb <span class="o">*</span> <span class="m">25</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span>      <span class="c1"># 25% of total memory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">effective_cache_size</span><span class="o">=</span><span class="k">$((</span>memory_gb <span class="o">*</span> <span class="m">75</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span> <span class="c1"># 75% of total memory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">work_mem</span><span class="o">=</span><span class="k">$((</span>memory_gb <span class="o">*</span> <span class="m">1024</span> <span class="o">/</span> cpu_cores <span class="o">/</span> <span class="m">4</span><span class="k">))</span> <span class="c1"># Conservative work_mem</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Ensure minimum values</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="nv">$shared_buffers</span> -lt <span class="m">1</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">shared_buffers</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="nv">$effective_cache_size</span> -lt <span class="m">1</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">effective_cache_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="nv">$work_mem</span> -lt <span class="m">4</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">work_mem</span><span class="o">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    cat &gt; <span class="s2">&#34;</span><span class="nv">$config_file</span><span class="s2">&#34;</span> <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s"># Optimized PostgreSQL Configuration
</span></span></span><span class="line"><span class="cl"><span class="s"># Generated on $(date)
</span></span></span><span class="line"><span class="cl"><span class="s"># System: ${memory_gb}GB RAM, ${cpu_cores} CPU cores
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Memory Settings
</span></span></span><span class="line"><span class="cl"><span class="s">shared_buffers = ${shared_buffers}GB
</span></span></span><span class="line"><span class="cl"><span class="s">effective_cache_size = ${effective_cache_size}GB
</span></span></span><span class="line"><span class="cl"><span class="s">work_mem = ${work_mem}MB
</span></span></span><span class="line"><span class="cl"><span class="s">maintenance_work_mem = $((work_mem * 10))MB
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Connection Settings
</span></span></span><span class="line"><span class="cl"><span class="s">max_connections = $((cpu_cores * 25))
</span></span></span><span class="line"><span class="cl"><span class="s">shared_preload_libraries = &#39;pg_stat_statements&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># WAL Settings
</span></span></span><span class="line"><span class="cl"><span class="s">wal_buffers = 64MB
</span></span></span><span class="line"><span class="cl"><span class="s">checkpoint_completion_target = 0.9
</span></span></span><span class="line"><span class="cl"><span class="s">wal_writer_delay = 200ms
</span></span></span><span class="line"><span class="cl"><span class="s">commit_delay = 0
</span></span></span><span class="line"><span class="cl"><span class="s">commit_siblings = 5
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Query Planner
</span></span></span><span class="line"><span class="cl"><span class="s">random_page_cost = 1.1
</span></span></span><span class="line"><span class="cl"><span class="s">effective_io_concurrency = $((cpu_cores * 2))
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Logging
</span></span></span><span class="line"><span class="cl"><span class="s">log_destination = &#39;stderr&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">logging_collector = on
</span></span></span><span class="line"><span class="cl"><span class="s">log_directory = &#39;pg_log&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">log_filename = &#39;postgresql-%Y-%m-%d_%H%M%S.log&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">log_min_duration_statement = 1000
</span></span></span><span class="line"><span class="cl"><span class="s">log_checkpoints = on
</span></span></span><span class="line"><span class="cl"><span class="s">log_connections = on
</span></span></span><span class="line"><span class="cl"><span class="s">log_disconnections = on
</span></span></span><span class="line"><span class="cl"><span class="s">log_lock_waits = on
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Statistics
</span></span></span><span class="line"><span class="cl"><span class="s">track_activities = on
</span></span></span><span class="line"><span class="cl"><span class="s">track_counts = on
</span></span></span><span class="line"><span class="cl"><span class="s">track_io_timing = on
</span></span></span><span class="line"><span class="cl"><span class="s">track_functions = pl
</span></span></span><span class="line"><span class="cl"><span class="s">stats_temp_directory = &#39;/var/run/postgresql/stats_temp&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Autovacuum
</span></span></span><span class="line"><span class="cl"><span class="s">autovacuum = on
</span></span></span><span class="line"><span class="cl"><span class="s">autovacuum_max_workers = $((cpu_cores / 4 &gt; 1 ? cpu_cores / 4 : 1))
</span></span></span><span class="line"><span class="cl"><span class="s">autovacuum_naptime = 1min
</span></span></span><span class="line"><span class="cl"><span class="s">autovacuum_vacuum_threshold = 50
</span></span></span><span class="line"><span class="cl"><span class="s">autovacuum_analyze_threshold = 50
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Background Writer
</span></span></span><span class="line"><span class="cl"><span class="s">bgwriter_delay = 200ms
</span></span></span><span class="line"><span class="cl"><span class="s">bgwriter_lru_maxpages = 100
</span></span></span><span class="line"><span class="cl"><span class="s">bgwriter_lru_multiplier = 2.0
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Parallel Query
</span></span></span><span class="line"><span class="cl"><span class="s">max_worker_processes = $cpu_cores
</span></span></span><span class="line"><span class="cl"><span class="s">max_parallel_workers_per_gather = $((cpu_cores / 4 &gt; 1 ? cpu_cores / 4 : 1))
</span></span></span><span class="line"><span class="cl"><span class="s">max_parallel_workers = $cpu_cores
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;PostgreSQL configuration saved to: </span><span class="nv">$config_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Operating system optimization</span>
</span></span><span class="line"><span class="cl">optimize_os_settings<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">config_file</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONFIG_OUTPUT_DIR</span><span class="si">}</span><span class="s2">/os_optimizations.sh&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Generating OS optimization script...&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    cat &gt; <span class="s2">&#34;</span><span class="nv">$config_file</span><span class="s2">&#34;</span> <span class="s">&lt;&lt; &#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="s"># Operating System Optimizations for Database Performance
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Kernel parameters for database workloads
</span></span></span><span class="line"><span class="cl"><span class="s">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; &#39;SYSCTL_EOF</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># Memory management
</span></span></span><span class="line"><span class="cl"><span class="s1">vm.swappiness = 1
</span></span></span><span class="line"><span class="cl"><span class="s1">vm.dirty_ratio = 15
</span></span></span><span class="line"><span class="cl"><span class="s1">vm.dirty_background_ratio = 5
</span></span></span><span class="line"><span class="cl"><span class="s1">vm.dirty_expire_centisecs = 500
</span></span></span><span class="line"><span class="cl"><span class="s1">vm.dirty_writeback_centisecs = 100
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># Network settings
</span></span></span><span class="line"><span class="cl"><span class="s1">net.core.rmem_default = 262144
</span></span></span><span class="line"><span class="cl"><span class="s1">net.core.rmem_max = 16777216
</span></span></span><span class="line"><span class="cl"><span class="s1">net.core.wmem_default = 262144
</span></span></span><span class="line"><span class="cl"><span class="s1">net.core.wmem_max = 16777216
</span></span></span><span class="line"><span class="cl"><span class="s1">net.ipv4.tcp_rmem = 4096 65536 16777216
</span></span></span><span class="line"><span class="cl"><span class="s1">net.ipv4.tcp_wmem = 4096 65536 16777216
</span></span></span><span class="line"><span class="cl"><span class="s1">net.core.netdev_max_backlog = 5000
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># File system
</span></span></span><span class="line"><span class="cl"><span class="s1">fs.file-max = 2097152
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">SYSCTL_EOF
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># Apply kernel parameters
</span></span></span><span class="line"><span class="cl"><span class="s1">sysctl -p
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># I/O scheduler optimization
</span></span></span><span class="line"><span class="cl"><span class="s1">echo &#34;Setting I/O scheduler to deadline for database disks...&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">for disk in /sys/block/sd*; do
</span></span></span><span class="line"><span class="cl"><span class="s1">    if [[ -f &#34;$disk/queue/scheduler&#34; ]]; then
</span></span></span><span class="line"><span class="cl"><span class="s1">        echo deadline &gt; &#34;$disk/queue/scheduler&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">        echo &#34;Set deadline scheduler for $(basename $disk)&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">    fi
</span></span></span><span class="line"><span class="cl"><span class="s1">done
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># Disable transparent huge pages (often problematic for databases)
</span></span></span><span class="line"><span class="cl"><span class="s1">echo &#34;Disabling transparent huge pages...&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</span></span></span><span class="line"><span class="cl"><span class="s1">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"># Add to startup script
</span></span></span><span class="line"><span class="cl"><span class="s1">cat &gt;&gt; /etc/rc.local &lt;&lt; &#39;</span>RC_EOF<span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disable transparent huge pages</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag
</span></span><span class="line"><span class="cl">RC_EOF
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;OS optimizations applied. Reboot recommended.&#34;</span>
</span></span><span class="line"><span class="cl">EOF
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    chmod +x <span class="s2">&#34;</span><span class="nv">$config_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;OS optimization script saved to: </span><span class="nv">$config_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Storage optimization recommendations</span>
</span></span><span class="line"><span class="cl">analyze_storage<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Analyzing storage configuration...&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">report_file</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONFIG_OUTPUT_DIR</span><span class="si">}</span><span class="s2">/storage_analysis.txt&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Storage Analysis Report&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;======================&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Generated on </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Disk Usage:&#34;</span>
</span></span><span class="line"><span class="cl">        df -h
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Mount Options:&#34;</span>
</span></span><span class="line"><span class="cl">        mount <span class="p">|</span> grep -E <span class="s2">&#34;(ext4|xfs|btrfs)&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;I/O Statistics:&#34;</span>
</span></span><span class="line"><span class="cl">        iostat -x <span class="m">1</span> <span class="m">3</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&#34;iostat not available&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Recommendations:&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;1. Use separate disks for data, logs, and temp files&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;2. Consider RAID 10 for data files&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;3. Use SSD for transaction logs&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;4. Mount options: noatime,nodiratime for data partitions&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;5. Consider XFS or ext4 with appropriate block size&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Suggested mount options for database partitions:&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;/dev/sdb1 /var/lib/mysql ext4 defaults,noatime,nodiratime 0 2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;/dev/sdc1 /var/lib/mysql-logs ext4 defaults,noatime,nodiratime 0 2&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="o">}</span> &gt; <span class="s2">&#34;</span><span class="nv">$report_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Storage analysis saved to: </span><span class="nv">$report_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Main execution</span>
</span></span><span class="line"><span class="cl">main<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Starting database configuration tuning...&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create output directory</span>
</span></span><span class="line"><span class="cl">    mkdir -p <span class="s2">&#34;</span><span class="nv">$CONFIG_OUTPUT_DIR</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Gather system information</span>
</span></span><span class="line"><span class="cl">    get_system_info
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Generate optimized configurations</span>
</span></span><span class="line"><span class="cl">    optimize_mysql_config <span class="s2">&#34;</span><span class="nv">$TOTAL_MEMORY_GB</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$CPU_CORES</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    optimize_postgresql_config <span class="s2">&#34;</span><span class="nv">$TOTAL_MEMORY_GB</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$CPU_CORES</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    optimize_os_settings
</span></span><span class="line"><span class="cl">    analyze_storage
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Configuration tuning completed!&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Generated files in: </span><span class="nv">$CONFIG_OUTPUT_DIR</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    log <span class="s2">&#34;Review configurations before applying to production systems&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run main function</span>
</span></span><span class="line"><span class="cl">main <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span></code></pre></div><h2 id="caching-strategies">Caching Strategies</h2>
<h3 id="1-multi-level-cache-manager">1. Multi-Level Cache Manager</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># src/caching/cache_manager.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">redis</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">memcache</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CacheLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">L1_MEMORY</span> <span class="o">=</span> <span class="s2">&#34;l1_memory&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">L2_REDIS</span> <span class="o">=</span> <span class="s2">&#34;l2_redis&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">L3_MEMCACHED</span> <span class="o">=</span> <span class="s2">&#34;l3_memcached&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CacheConfig</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">l1_max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">    <span class="n">l1_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 5 minutes</span>
</span></span><span class="line"><span class="cl">    <span class="n">l2_host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">l2_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6379</span>
</span></span><span class="line"><span class="cl">    <span class="n">l2_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour</span>
</span></span><span class="line"><span class="cl">    <span class="n">l3_servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">l3_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7200</span>  <span class="c1"># 2 hours</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MultiLevelCacheManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CacheConfig</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logging</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># L1 Cache: In-memory dictionary with LRU eviction</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">l1_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># L2 Cache: Redis</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">l2_host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">port</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">l2_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Redis not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># L3 Cache: Memcached</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">l3_servers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">memcached_client</span> <span class="o">=</span> <span class="n">memcache</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">l3_servers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Test connection</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">memcached_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Memcached not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Statistics</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;l1_hits&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;l1_misses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;l2_hits&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;l2_misses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;l3_hits&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;l3_misses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;total_requests&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stats_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;CacheManager&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Generate consistent cache key&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Update cache statistics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_requests&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">hit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">_hits&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">_misses&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_l1_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get from L1 cache&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;expires&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Move to end (most recently used)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Expired</span>
</span></span><span class="line"><span class="cl">                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_l1_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Set in L1 cache&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Evict if at capacity</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l1_max_size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">oldest_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">oldest_key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;expires&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">ttl</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_l2_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get from L2 cache (Redis)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Redis get error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_l2_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Set in L2 cache (Redis)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Redis set error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_l3_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get from L3 cache (Memcached)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memcached_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Memcached get error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_l3_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Set in L3 cache (Memcached)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">memcached_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span> <span class="n">time</span><span class="o">=</span><span class="n">ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Memcached set error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get value from cache (tries all levels)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Try L1 first</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l1_get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Try L2</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l2_get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Populate L1</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_l1_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l1_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Try L3</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l3_get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Populate L1 and L2</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_l1_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l1_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_l2_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l2_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Set value in all cache levels&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Use default TTLs if not specified</span>
</span></span><span class="line"><span class="cl">        <span class="n">l1_ttl</span> <span class="o">=</span> <span class="n">ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l1_ttl</span>
</span></span><span class="line"><span class="cl">        <span class="n">l2_ttl</span> <span class="o">=</span> <span class="n">ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l2_ttl</span>
</span></span><span class="line"><span class="cl">        <span class="n">l3_ttl</span> <span class="o">=</span> <span class="n">ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">l3_ttl</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Set in all levels</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_l1_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">l1_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_l2_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">l2_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_l3_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">l3_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Delete from all cache levels&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Delete from L1</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Delete from L2</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Redis delete error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Delete from L3</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">memcached_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Memcached delete error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Clear all cache levels&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Clear L1</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">l1_access_order</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Clear L2</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">flushdb</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Redis clear error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Clear L3</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">memcached_client</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Memcached clear error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get cache statistics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;l1_hits&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;l2_hits&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;l3_hits&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_misses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;l1_misses&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;l2_misses&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;l3_misses&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">hit_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_hits</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_hits</span> <span class="o">+</span> <span class="n">total_misses</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="p">(</span><span class="n">total_hits</span> <span class="o">+</span> <span class="n">total_misses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;total_hits&#39;</span><span class="p">:</span> <span class="n">total_hits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;total_misses&#39;</span><span class="p">:</span> <span class="n">total_misses</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;hit_rate_percent&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hit_rate</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;l1_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;l2_available&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_available</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;l3_available&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_available</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Cache decorator</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cached</span><span class="p">(</span><span class="n">cache_manager</span><span class="p">:</span> <span class="n">MultiLevelCacheManager</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Decorator for caching function results&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Generate cache key from function name and arguments</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_prefix</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&#34;:&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_parts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Try to get from cache</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">cache_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Execute function and cache result</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cache_manager</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">wrapper</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decorator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Configure cache</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="n">CacheConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">l1_max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">l1_ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">l2_host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">l2_port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">l2_ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">l3_servers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;localhost:11211&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">l3_ttl</span><span class="o">=</span><span class="mi">7200</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create cache manager</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">MultiLevelCacheManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Example cached function</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@cached</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s2">&#34;user_data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simulate database query</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Simulate query time</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;user</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s1">@example.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Test caching</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Testing multi-level cache...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># First call - cache miss</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_data</span> <span class="o">=</span> <span class="n">get_user_data</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_call_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First call (cache miss): </span><span class="si">{</span><span class="n">first_call_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;User data: </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Second call - cache hit</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_data</span> <span class="o">=</span> <span class="n">get_user_data</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">second_call_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Second call (cache hit): </span><span class="si">{</span><span class="n">second_call_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Show cache statistics</span>
</span></span><span class="line"><span class="cl">    <span class="n">stats</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Cache Statistics:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="summary">Summary</h2>
<p>This comprehensive database performance optimization guide provides practical strategies and tools for improving database performance across multiple dimensions:</p>
<h3 id="key-optimization-areas">Key Optimization Areas</h3>
<ol>
<li><strong>Performance Monitoring</strong>: Real-time metrics collection and analysis</li>
<li><strong>Query Optimization</strong>: Automated query analysis and improvement suggestions</li>
<li><strong>Indexing Strategies</strong>: Intelligent index recommendations based on workload analysis</li>
<li><strong>Schema Design</strong>: Best practices for efficient database schema design</li>
<li><strong>System Configuration</strong>: Optimized database and OS configurations</li>
<li><strong>Caching</strong>: Multi-level caching strategies for improved response times</li>
</ol>
<h3 id="best-practices">Best Practices</h3>
<ul>
<li><strong>Proactive Monitoring</strong>: Implement comprehensive monitoring before performance issues arise</li>
<li><strong>Data-Driven Decisions</strong>: Use actual workload data to guide optimization efforts</li>
<li><strong>Incremental Improvements</strong>: Apply optimizations gradually and measure their impact</li>
<li><strong>Regular Maintenance</strong>: Schedule regular performance reviews and optimizations</li>
<li><strong>Documentation</strong>: Maintain detailed records of all optimization changes</li>
</ul>
<h3 id="implementation-strategy">Implementation Strategy</h3>
<ol>
<li>Start with monitoring and baseline establishment</li>
<li>Identify the most impactful optimization opportunities</li>
<li>Implement changes in a controlled manner</li>
<li>Measure and validate improvements</li>
<li>Iterate and refine based on results</li>
</ol>
<p>The tools and techniques presented in this guide can be adapted to various database systems and scaled according to your specific requirements. Remember that performance optimization is an ongoing process that requires continuous attention and refinement.</p>

            </div>

            
            

            
            

            
            
            <div class="mt-12 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    Ê†áÁ≠æ
                </h3>
                <div class="flex flex-wrap gap-2">
                    
                    <a href="/tags/database"
                        class="inline-block px-3 py-1 text-sm text-gray-600 bg-gray-100 rounded-full hover:bg-primary-100 hover:text-primary-700 transition-colors duration-200">
                        #Database
                    </a>
                    
                    <a href="/tags/performance"
                        class="inline-block px-3 py-1 text-sm text-gray-600 bg-gray-100 rounded-full hover:bg-primary-100 hover:text-primary-700 transition-colors duration-200">
                        #Performance
                    </a>
                    
                    <a href="/tags/optimization"
                        class="inline-block px-3 py-1 text-sm text-gray-600 bg-gray-100 rounded-full hover:bg-primary-100 hover:text-primary-700 transition-colors duration-200">
                        #Optimization
                    </a>
                    
                    <a href="/tags/sql"
                        class="inline-block px-3 py-1 text-sm text-gray-600 bg-gray-100 rounded-full hover:bg-primary-100 hover:text-primary-700 transition-colors duration-200">
                        #SQL
                    </a>
                    
                    <a href="/tags/indexing"
                        class="inline-block px-3 py-1 text-sm text-gray-600 bg-gray-100 rounded-full hover:bg-primary-100 hover:text-primary-700 transition-colors duration-200">
                        #Indexing
                    </a>
                    
                </div>
            </div>
            

            
            <div class="mt-8 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    ÂàÜ‰∫´ÊñáÁ´†
                </h3>
                <div class="flex flex-wrap gap-4">
                    
                    <a href="https://x.com/intent/tweet?url=https%3a%2f%2fwww.dishuihengxin.com%2fposts%2fdatabase-performance-optimization%2f&amp;text=Database%20Performance%20Optimization%20Strategies%3a%20From%20Query%20Tuning%20to%20System%20Architecture"
                        target="_blank" rel="noopener noreferrer"
                        class="inline-flex items-center px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        X
                    </a>

                    
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.dishuihengxin.com%2fposts%2fdatabase-performance-optimization%2f" target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                        </svg>
                        Facebook
                    </a>

                    
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fwww.dishuihengxin.com%2fposts%2fdatabase-performance-optimization%2f" target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                        </svg>
                        LinkedIn
                    </a>

                    
                    <button onclick="copyToClipboard('https:\/\/www.dishuihengxin.com\/posts\/database-performance-optimization\/')"
                        class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                        Â§çÂà∂ÈìæÊé•
                    </button>
                </div>
            </div>

            
            <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <a href="/posts/database-security-access-control/"
                        class="group flex items-center p-6 bg-gray-50 dark:bg-gray-800 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-200">
                        <div class="flex-shrink-0 mr-4">
                            <svg class="w-6 h-6 text-gray-400 group-hover:text-purple-600 transition-colors" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7">
                                </path>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">
                                ‰∏ä‰∏ÄÁØá
                            </div>
                            <div
                                class="font-semibold text-gray-900 dark:text-white truncate group-hover:text-purple-600 transition-colors">
                                Database Security and Access Control: A Comprehensive Guide to Protecting Your Data
                            </div>
                        </div>
                    </a>
                    

                    
                </div>
            </div>

        </article>

        
        <aside class="w-full lg:w-[320px]">
            <div class="sticky top-24 space-y-6">
                
                
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                    <h3
                        class="text-lg font-semibold text-gray-900 dark:text-white mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                            </path>
                        </svg>
                        ÂÜÖÂÆπÂØºËà™
                    </h3>
                    <div id="toc-content" class="toc text-sm space-y-1">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-contents">Table of Contents</a></li>
    <li><a href="#performance-analysis-and-monitoring">Performance Analysis and Monitoring</a>
      <ul>
        <li><a href="#1-performance-metrics-collection">1. Performance Metrics Collection</a></li>
      </ul>
    </li>
    <li><a href="#query-optimization-techniques">Query Optimization Techniques</a>
      <ul>
        <li><a href="#1-sql-query-analyzer">1. SQL Query Analyzer</a></li>
      </ul>
    </li>
    <li><a href="#indexing-strategies">Indexing Strategies</a>
      <ul>
        <li><a href="#1-index-recommendation-engine">1. Index Recommendation Engine</a></li>
      </ul>
    </li>
    <li><a href="#database-schema-design">Database Schema Design</a>
      <ul>
        <li><a href="#1-schema-optimization-analyzer">1. Schema Optimization Analyzer</a></li>
      </ul>
    </li>
    <li><a href="#system-level-optimization">System-Level Optimization</a>
      <ul>
        <li><a href="#1-database-configuration-tuner">1. Database Configuration Tuner</a></li>
      </ul>
    </li>
    <li><a href="#caching-strategies">Caching Strategies</a>
      <ul>
        <li><a href="#1-multi-level-cache-manager">1. Multi-Level Cache Manager</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a>
      <ul>
        <li><a href="#key-optimization-areas">Key Optimization Areas</a></li>
        <li><a href="#best-practices">Best Practices</a></li>
        <li><a href="#implementation-strategy">Implementation Strategy</a></li>
      </ul>
    </li>
  </ul>
</nav>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2">
                            <span>ÈòÖËØªËøõÂ∫¶</span>
                            <span id="reading-progress-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="reading-progress-bar"
                                class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-300 progress-bar-width-0">
                            </div>
                        </div>
                    </div>
                </div>
                

                
                
                
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                        Áõ∏ÂÖ≥Êé®Ëçê
                    </h3>
                    <div class="space-y-4">
                        
                        <article class="group">
                            <a href="/posts/database-security-access-control/" class="block">
                                
                                <h4
                                    class="font-semibold text-gray-900 dark:text-white group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors line-clamp-2 mb-2">
                                    Database Security and Access Control: A Comprehensive Guide to Protecting Your Data
                                </h4>
                                <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <time datetime="2025-12-31">
                                        2025-12-31
                                    </time>
                                </div>
                            </a>
                        </article>
                        
                    </div>
                </div>
                

                
                
            </div>
        </aside>
    </div>
</div>


<script>
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function () {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Â∑≤Â§çÂà∂
        `;
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        });
    }

    
    document.addEventListener('DOMContentLoaded', function () {
        const progressBar = document.getElementById('reading-progress-bar');
        const progressText = document.getElementById('reading-progress-text');
        const tocLinks = document.querySelectorAll('#toc-content a');
        const headings = Array.from(document.querySelectorAll('article h1, article h2, article h3, article h4, article h5, article h6'));

        
        function updateReadingProgress() {
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight - windowHeight;
            const scrolled = window.scrollY;
            const progress = documentHeight > 0 ? (scrolled / documentHeight) * 100 : 0;

            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            if (progressText) {
                progressText.textContent = Math.round(progress) + '%';
            }

            
            
            let activeHeading = null;
            const readingLine = 150; 

            for (let i = 0; i < headings.length; i++) {
                const heading = headings[i];
                const rect = heading.getBoundingClientRect();

                
                if (rect.top <= readingLine) {
                    activeHeading = heading;
                } else {
                    
                    break;
                }
            }

            
            const activeId = activeHeading ? activeHeading.id : null;
            const currentActiveLink = document.querySelector('#toc-content a.active-toc-item');
            const currentActiveId = currentActiveLink ? currentActiveLink.getAttribute('href').substring(1) : null;

            if (activeId !== currentActiveId) {
                
                tocLinks.forEach(link => {
                    link.classList.remove('active-toc-item');

                    const href = link.getAttribute('href');
                    if (activeId && href === '#' + activeId) {
                        link.classList.add('active-toc-item');

                        
                        const tocContainer = document.getElementById('toc-content');
                        if (tocContainer) {
                            const linkRect = link.getBoundingClientRect();
                            const containerRect = tocContainer.getBoundingClientRect();

                            
                            if (linkRect.top < containerRect.top + 20 || linkRect.bottom > containerRect.bottom - 20) {
                                
                                link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                    }
                });
            }
        }

        let isScrolling = false;
        window.addEventListener('scroll', () => {
            if (!isScrolling) {
                window.requestAnimationFrame(() => {
                    updateReadingProgress();
                    isScrolling = false;
                });
                isScrolling = true;
            }
        });
        updateReadingProgress();

        

        
        const viewCount = document.getElementById('view-count');
        if (viewCount) {
            const count = Math.floor(Math.random() * 1000) + 100;
            viewCount.textContent = count;
        }
    });
</script>


<style>
    .code-block-wrapper {
        position: relative;
        margin: 1.5rem 0;
    }

    .code-block-wrapper pre {
        margin: 0;
        background: #f6f8fa !important;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        padding: 16px;
        overflow-x: auto;
        font-size: 14px;
        line-height: 1.45;
    }

    .dark .code-block-wrapper pre {
        background: #0d1117 !important;
        border-color: #30363d;
    }

    .code-block-wrapper pre code {
        background: transparent !important;
        padding: 0 !important;
        border: none !important;
        font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
        color: #24292f;
    }

    .dark .code-block-wrapper pre code {
        color: #c9d1d9;
    }

     
    :not(pre)>code {
        background: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: 3px;
        padding: 0.2em 0.4em;
        font-size: 85%;
        font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
        color: #24292f;
    }

    .dark :not(pre)>code {
        background: #161b22;
        border-color: #30363d;
        color: #c9d1d9;
    }

     
    #toc-content {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    #toc-content::-webkit-scrollbar {
        width: 4px;
    }

    #toc-content::-webkit-scrollbar-track {
        background: transparent;
    }

    #toc-content::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.3);
        border-radius: 2px;
    }

    #toc-content::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 92, 246, 0.5);
    }

    #toc-content ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    #toc-content ul ul {
        padding-left: 0.75rem;
        margin-top: 0;
    }

    #toc-content li {
        margin: 0;
    }

    #toc-content a {
        display: block;
        padding: 0.35rem 0.5rem;
         
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        text-decoration: none;
        border-left: 3px solid transparent;
        color: #4b5563;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .dark #toc-content a {
        color: #9ca3af;
    }

    #toc-content a:hover {
        background: rgba(139, 92, 246, 0.05);
        color: #7c3aed;
    }

    .dark #toc-content a:hover {
        background: rgba(139, 92, 246, 0.1);
        color: #a78bfa;
    }

     
    #toc-content a.active-toc-item {
        background: rgba(139, 92, 246, 0.1);
        border-left-color: #7c3aed;
         
        color: #7c3aed;
         
        font-weight: 600;
    }

    .dark #toc-content a.active-toc-item {
        background: rgba(139, 92, 246, 0.15);
        border-left-color: #a78bfa;
        color: #a78bfa;
    }

     
    aside .sticky {
        position: sticky;
        top: 6rem;
    }

     
    .article-content>h1:first-child {
        display: none;
    }
</style>

    </main>

    
    <div class="relative z-20">
        <section role="contentinfo" aria-label="Site Footer" class="bg-gray-900 text-gray-300">
    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
            
            <div>
                <div class="flex items-center space-x-3 mb-4">
                    <img src="/images/logo.png" alt="Êª¥Ê∞¥ÊÅíÂøÉ Logo"
                        class="w-10 h-10 object-contain">
                    <span class="text-xl font-bold text-white">Êª¥Ê∞¥ÊÅíÂøÉ</span>
                </div>
                <p class="text-gray-400 text-sm leading-relaxed mb-6">
                    
                    ‰∏ìÊ≥®‰∫éÊäÄÊúØÂàÜ‰∫´‰∏é‰∫§ÊµÅÔºåËá¥Âäõ‰∫éÂ∏ÆÂä©ÂºÄÂèëËÄÖÊàêÈïø„ÄÇÂàÜ‰∫´ÊúÄÊñ∞ÊäÄÊúØË∂ãÂäø„ÄÅÂÆûÊàòÁªèÈ™åÂíåÂºÄÂèëÊäÄÂ∑ß„ÄÇ
                    
                </p>

                
                <div class="flex flex-wrap gap-3">
                    <a href="https://github.com/dishuihengxin" target="_blank"
                        rel="noopener noreferrer"
                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white transition-all duration-200"
                        aria-label="GitHub">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                        </svg>
                    </a>
                    <a href="https://x.com/dishuihengxin" target="_blank"
                        rel="noopener noreferrer"
                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white transition-all duration-200"
                        aria-label="X">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://linkedin.com/in/dishuihengxin" target="_blank"
                        rel="noopener noreferrer"
                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white transition-all duration-200"
                        aria-label="LinkedIn">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                        </svg>
                    </a>
                    <a href="mailto:dishuihengxin@gmail.com"
                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white transition-all duration-200"
                        aria-label="Email">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </a>
                </div>
            </div>

            
            <div>
                <h3 class="text-white font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Âø´ÈÄüÈìæÊé•
                </h3>
                <ul class="space-y-3">
                    <li>
                        <a href="/categories/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm flex items-center group">
                            <svg class="w-4 h-4 mr-2 text-gray-500 group-hover:text-blue-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                                </path>
                            </svg>
                            ÂàÜÁ±ª
                        </a>
                    </li>
                    <li>
                        <a href="/tags/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm flex items-center group">
                            <svg class="w-4 h-4 mr-2 text-gray-500 group-hover:text-blue-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                </path>
                            </svg>
                            Ê†áÁ≠æ
                        </a>
                    </li>
                    <li>
                        <a href="/archive/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm flex items-center group">
                            <svg class="w-4 h-4 mr-2 text-gray-500 group-hover:text-blue-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                                </path>
                            </svg>
                            ÂΩíÊ°£
                        </a>
                    </li>
                    <li>
                        <a href="/about/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm flex items-center group">
                            <svg class="w-4 h-4 mr-2 text-gray-500 group-hover:text-blue-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ÂÖ≥‰∫é
                        </a>
                    </li>
                    <li>
                        <a href="/changelog/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm flex items-center group">
                            <svg class="w-4 h-4 mr-2 text-gray-500 group-hover:text-blue-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            Êõ¥Êñ∞Êó•Âøó
                        </a>
                    </li>
                </ul>
            </div>

            
            <div>
                <h3 class="text-white font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z">
                        </path>
                    </svg>
                    Êé®ËçêÈòÖËØª
                </h3>
                <ul class="space-y-3">
                    
                    <li>
                        <a href="https://www.dishuihengxin.com/posts/database-performance-optimization/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm block group">
                            <div class="flex items-start">
                                <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-600 group-hover:text-green-400 transition-colors flex-shrink-0"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span class="truncate">Database Performance Optimization Strategies: From Query Tuning to System Architecture</span>
                            </div>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.dishuihengxin.com/posts/database-security-access-control/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm block group">
                            <div class="flex items-start">
                                <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-600 group-hover:text-green-400 transition-colors flex-shrink-0"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span class="truncate">Database Security and Access Control: A Comprehensive Guide to Protecting Your Data</span>
                            </div>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.dishuihengxin.com/posts/database-elasticsearch-optimization/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm block group">
                            <div class="flex items-start">
                                <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-600 group-hover:text-green-400 transition-colors flex-shrink-0"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span class="truncate">ElasticsearchÊêúÁ¥¢ÂºïÊìé‰ºòÂåñÔºö‰ªéÁ¥¢ÂºïËÆæËÆ°Âà∞Êü•ËØ¢ÊÄßËÉΩË∞É‰ºòÁöÑÂÆåÊï¥ÊåáÂçó</span>
                            </div>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.dishuihengxin.com/posts/database-influxdb-timeseries/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm block group">
                            <div class="flex items-start">
                                <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-600 group-hover:text-green-400 transition-colors flex-shrink-0"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span class="truncate">InfluxDBÊó∂Â∫èÊï∞ÊçÆÂ∫ìËÆæËÆ°‰∏éÂÆûË∑µÔºö‰ªéÊï∞ÊçÆÂª∫Ê®°Âà∞È´òÊÄßËÉΩÊü•ËØ¢‰ºòÂåñ</span>
                            </div>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.dishuihengxin.com/posts/kubernetes-container-orchestration-guide/"
                            class="text-gray-400 hover:text-white transition-colors duration-200 text-sm block group">
                            <div class="flex items-start">
                                <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-600 group-hover:text-green-400 transition-colors flex-shrink-0"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span class="truncate">Kubernetes Container Orchestration: A Comprehensive Guide to Cloud-Native Deployment</span>
                            </div>
                        </a>
                    </li>
                    
                </ul>
            </div>

            
            <div>
                <h3 class="text-white font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                        </path>
                    </svg>
                    ÂÖ≥Ê≥®Êàë‰ª¨
                </h3>

                
                <img src="/images/qrcode.jpg" alt="ÂÖ¨‰ºóÂè∑‰∫åÁª¥Á†Å" class="w-24 h-24 rounded-lg shadow-lg mb-4">

                <p class="text-xs text-gray-400">
                    Êâ´Á†ÅÂÖ≥Ê≥®ÂÖ¨‰ºóÂè∑
                </p>
            </div>
        </div>

        
        <div class="border-t border-gray-800 mt-10 pt-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                
                <div class="text-gray-400 text-sm text-center md:text-left">
                    ¬© 2026 Êª¥Ê∞¥ÊÅíÂøÉ.
                    
                    ‰øùÁïôÊâÄÊúâÊùÉÂà©„ÄÇ
                    
                </div>

                
                <div class="flex flex-wrap items-center justify-center gap-3 text-sm">
                    <a href="/privacy/"
                        class="text-gray-400 hover:text-white transition-colors duration-200">
                        ÈöêÁßÅÊîøÁ≠ñ
                    </a>
                    <span class="text-gray-700">|</span>
                    <a href="/terms/"
                        class="text-gray-400 hover:text-white transition-colors duration-200">
                        ‰ΩøÁî®Êù°Ê¨æ
                    </a>
                    <span class="text-gray-700">|</span>
                    <a href="/index.xml"
                        class="text-gray-400 hover:text-white transition-colors duration-200 inline-flex items-center gap-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
                        </svg>
                        RSS
                    </a>
                    <span class="text-gray-700">|</span>
                    <a href="/sitemap.xml"
                        class="text-gray-400 hover:text-white transition-colors duration-200 inline-flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7">
                            </path>
                        </svg>
                        ÁΩëÁ´ôÂú∞Âõæ
                    </a>
                </div>
            </div>
        </div>
    </footer>
</section>
    </div>

    

    
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js" defer></script>

    
    
    
    
    
    
    <script src="/js/config.min.4e32dae1da8cb8e073e384e9bf17d0c048ae80f1ab72ece6507a3171fbfe62ea.js"></script>
    

    
    
    
    
    
    <script src="/js/theme-manager.min.80c7c5887d95e238a4626d07a137b2255878adff8f66394c2edb9a179f779739.js"></script>
    

    
    
    
    
    
    
    <script src="/js/security.min.97da30d986f7469868b11716a3fe9ba5b6516c39d958e471c0634d3a3f842ab4.js" defer></script>
    

    
    

    
    

    
    

    
    

    
    
    
    
    
    
    <script src="/js/analytics.min.e9c247ba215787d5828ba98cca7bb28ca42f0527f6054bc2f640f59a99a94aa7.js?v=1767262346" defer></script>
    

    
    
    
    
    
    
    <script src="/js/search.min.b0ead121c4ae8a19b5689d834fd825a1214aaa1d9979e170f900bb2879a23819.js" defer></script>
    

    
    

    
    

    
    
    
    
    
    
    <script src="/js/interactions.min.ac95880fe48f06ba1594fc48c95de264f14b703f6e94ccafe53eaaefefa32682.js" defer></script>
    



    
    
    
    
    
    
    <script src="/js/main.min.1db3c2db630282d627f674c53069de74db16f4265e72ab68e0a15e1477917e8c.js?v=1767262346" defer></script>
    

    
    

    
    




  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cdb9c487f6c71421e1844a7cc0fd40e9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  




  
    
<script 
  defer 
  src="https://cloud.umami.is/script.js"
  data-website-id="9b11a70f-0a77-48ae-b986-03144bf118b8" data-do-not-track="true" data-domains="dishuihengxin.com"
></script>
    
  



    
    
    
    
    
    
    <script src="/js/fallback-theme.min.ad9490b67677d21ebf98c40c1cf51743318b6bc5d5e2c9f0e25f5ba57a1aecb1.js" defer></script>
    

    
    
    
    
    
    
    <script src="/js/hero-slider.min.1d6c0e80fe2af86085c169ed34bf8dd76f4bfc3cb37d92c063812c65a3ede326.js" defer></script>
    

    
    
    
    
    
    
    <script src="/js/hero-particle-system.min.0bbe8a66b536f8652ac2006fb0a65ff3ca52367f952f7fe7c18082b1303bf9b6.js" defer></script>
    
</body>

</html>